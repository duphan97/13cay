<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìú L·ªãch S·ª≠ Ti·∫øn L√™n Mi·ªÅn Trung</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script> 
    <style>
        body {
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
            background-color: #f3f4f6;
        }
        
        #root {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* CƒÉn ch·ªânh hi·ªÉn th·ªã Rank Count */
        .rank-count {
            display: inline-block;
            width: 40px; /* ƒê·ªô r·ªông c·ªë ƒë·ªãnh */
            text-align: center;
            font-weight: 700;
        }
    </style>
</head>
<body>
    <div id="root"></div>
	<script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;

        // --- C·∫§U H√åNH GITHUB ---
        const REPO_OWNER = 'duphan97';
        const REPO_NAME = '13cay'; 
        const DATA_FILE_PATH = 'data/session_history.json'; 
        const GITHUB_API_URL = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${DATA_FILE_PATH}`;
        // --- END C·∫§U H√åNH GITHUB ---


        // --- BASE64 AN TO√ÄN CHO UNICODE ---
        const b64ToUnicode = (str) => decodeURIComponent(
            Array.prototype.map.call(atob(str), (c) => 
                '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
            ).join('')
        );
        // --- END FIX ---


        // H√†m T·∫£i l·ªãch s·ª≠ tr·ª±c ti·∫øp t·ª´ GitHub
        const fetchHistoryFromGitHub = async () => {
            const response = await fetch(GITHUB_API_URL, {
                method: 'GET',
                headers: {
                    'Accept': 'application/vnd.github.v3+json', 
                },
            });

            if (response.status === 404) {
                return []; 
            }
            if (!response.ok) {
                throw new Error(`L·ªói t·∫£i d·ªØ li·ªáu t·ª´ GitHub: ${response.statusText}`);
            }

            const fileData = await response.json();
            
            const encodedContent = fileData.content;
            let sessionsData;
            try {
                const jsonString = b64ToUnicode(encodedContent); 
                sessionsData = JSON.parse(jsonString);
            } catch (e) {
                console.error("L·ªói Decode/Parse JSON:", e);
                return []; 
            }
            
            return sessionsData; 
        };

        // --- H√ÄM T√çNH TO√ÅN T·ªîNG H·ª¢P (CH·ªà D·ª∞A V√ÄO RANK) ---
        const calculateAllTimeData = (sessions) => {
            if (!sessions || sessions.length === 0) return { scoreboard: [] };
            
            const rankCountsMap = {}; 

            sessions.forEach(session => {
                if (Array.isArray(session.game)) { 
                    
                    session.game.forEach(player => {
                        const rank = player.rank;
                        const playerName = player.name;
                        
                        rankCountsMap[playerName] = rankCountsMap[playerName] || { 1: 0, 2: 0, 3: 0, 4: 0, totalGames: 0 };
                        
                        if (rank >= 1 && rank <= 4) {
                            rankCountsMap[playerName][rank]++;
                        }
                        
                        rankCountsMap[playerName].totalGames++;
                    });
                }
            });

            const scoreboard = Object.keys(rankCountsMap).map(name => ({
                name,
                ranks: rankCountsMap[name],
                totalGames: rankCountsMap[name].totalGames
            }));
            
            // Logic s·∫Øp x·∫øp: ∆Øu ti√™n Rank 1 > Rank 2 > Rank 3. Rank 4 (√≠t l·∫ßn h∆°n l√† t·ªët h∆°n).
            scoreboard.sort((a, b) => {
                if (b.ranks['1'] !== a.ranks['1']) return b.ranks['1'] - a.ranks['1'];
                if (b.ranks['2'] !== a.ranks['2']) return b.ranks['2'] - a.ranks['2'];
                if (b.ranks['3'] !== a.ranks['3']) return b.ranks['3'] - a.ranks['3'];
                if (a.ranks['4'] !== b.ranks['4']) return a.ranks['4'] - b.ranks['4'];
                return b.totalGames - a.totalGames; 
            });

            return { scoreboard };
        };
        // --- END H√ÄM T√çNH TO√ÅN T·ªîNG H·ª¢P ---


        function HistoryTLMNApp() {
            const [sessions, setSessions] = useState(null);
            const [loading, setLoading] = useState(true); 
            const [dataError, setDataError] = useState(null); 
            
            useEffect(() => {
                const loadHistory = async () => {
                    setLoading(true);
                    setDataError(null);
                    try {
                        const data = await fetchHistoryFromGitHub();
                        setSessions(data);
                    } catch (err) {
                        console.error("L·ªói t·∫£i l·ªãch s·ª≠:", err.message);
                        setDataError("ƒê√£ x·∫£y ra l·ªói khi t·∫£i d·ªØ li·ªáu l·ªãch s·ª≠ t·ª´ GitHub.");
                        setSessions([]);
                    } finally {
                        setLoading(false);
                    }
                };

                loadHistory();
            }, []);

            const allTimeData = useMemo(() => calculateAllTimeData(sessions), [sessions]);
            const allTimeScoreboard = allTimeData.scoreboard;


            // --- Giao di·ªán T·∫£i/L·ªói ---
            if (loading || sessions === null) {
                return (
                    <div className="text-center p-8 min-h-[50vh] flex flex-col justify-center">
                        <p className="font-semibold mb-4 text-blue-600">ƒêang t·∫£i l·ªãch s·ª≠ t·ªïng h·ª£p...</p>
                        <div className="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-500 mx-auto"></div>
                    </div>
                );
            }

            if (dataError) {
                return (
                    <div className="text-center p-8 bg-red-100 border border-red-400 rounded-xl shadow-lg">
                        <p className="font-bold text-red-700 text-lg">‚ö†Ô∏è L·ªói T·∫£i D·ªØ Li·ªáu</p>
                        <p className="text-base text-gray-600 mt-2">{dataError}</p>
                        <a href="index.html" className="inline-block bg-indigo-500 text-white px-5 py-2 rounded-lg font-bold hover:bg-indigo-600 transition mt-4 shadow-md">
                            ‚Ü©Ô∏è Quay l·∫°i Game
                        </a>
                    </div>
                );
            }

            if (allTimeScoreboard.length === 0) { 
                return (
                    <div className="text-center p-8 bg-yellow-100 border border-yellow-400 rounded-xl shadow-lg">
                        <p className="font-bold text-yellow-700 text-lg">üìú Ch∆∞a C√≥ D·ªØ Li·ªáu L·ªãch S·ª≠</p>
                        <p className="text-base text-gray-600 mt-2">H√£y ho√†n th√†nh m·ªôt phi√™n ch∆°i ƒë·ªÉ h·ªá th·ªëng t·ª± ƒë·ªông l∆∞u.</p>
                        <a href="index.html" className="inline-block bg-indigo-500 text-white px-5 py-2 rounded-lg font-bold hover:bg-indigo-600 transition mt-4 shadow-md">
                            ‚Ü©Ô∏è Quay l·∫°i Game
                        </a>
                    </div>
                );
            }

            // --- Giao di·ªán L·ªãch s·ª≠ & BXH ---
            return (
                <div>
                    {/* ƒê√É C·∫¨P NH·∫¨T M√ÄU TI√äU ƒê·ªÄ TH√ÄNH indigo-700 */}
                    <h1 className="text-3xl font-extrabold text-center text-indigo-700 mb-8">üìú B·∫£ng X·∫øp H·∫°ng T·ªïng H·ª£p ({sessions.length} Phi√™n)</h1>
                    
                    {/* B·∫¢NG X·∫æP H·∫†NG RANK COUNT */}
                    <div className="mb-10 p-5 bg-indigo-50 border border-indigo-200 rounded-xl shadow-xl">
                        <h2 className="text-2xl font-bold text-indigo-600 mb-4 text-center border-b pb-2">üèÜ Th·ªëng K√™ S·ªë L·∫ßn ƒê·∫°t Rank</h2>
                        
                        {/* Header c·ªßa b·∫£ng Rank Count */}
                        <div className="flex justify-between items-center px-3 py-2 text-sm font-bold text-gray-600 border-b border-gray-300 mb-2">
                            <span className="w-1/3 text-left">Ng∆∞·ªùi ch∆°i (S·ªë Game: {allTimeScoreboard[0].totalGames})</span>
                            <div className="flex w-2/3 justify-end text-center">
                                <span className="rank-count" title="S·ªë l·∫ßn ƒë·∫°t H·∫°ng 1">ü•á R1</span>
                                <span className="rank-count" title="S·ªë l·∫ßn ƒë·∫°t H·∫°ng 2">ü•à R2</span>
                                <span className="rank-count" title="S·ªë l·∫ßn ƒë·∫°t H·∫°ng 3">ü•â R3</span>
                                <span className="rank-count" title="S·ªë l·∫ßn ƒë·∫°t H·∫°ng 4">üí© R4</span>
                            </div>
                        </div>

                        <div className="space-y-2">
                            {allTimeScoreboard.map((p, index) => (
                                <div key={p.name} className={`flex justify-between items-center p-3 rounded-lg transition duration-150 ${index === 0 ? 'bg-yellow-100 font-extrabold border-l-4 border-yellow-500' : 'bg-white border hover:bg-gray-50'}`}>
                                    
                                    {/* T√™n Ng∆∞·ªùi Ch∆°i */}
                                    <span className="text-base font-semibold w-1/3 overflow-hidden text-ellipsis whitespace-nowrap">
                                        {index === 0 && 'üëë'} {p.name}
                                    </span>
                                    
                                    {/* Rank Count */}
                                    <div className="flex w-2/3 justify-end items-center">
                                        <span className="rank-count text-green-600">{p.ranks['1']}</span>
                                        <span className="rank-count text-blue-600">{p.ranks['2']}</span>
                                        <span className="rank-count text-orange-600">{p.ranks['3']}</span>
                                        <span className="rank-count text-red-600">{p.ranks['4']}</span>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                    
                    <div className="text-center mt-8">
                        {/* ƒê√É C·∫¨P NH·∫¨T M√ÄU N√öT QUAY L·∫†I GAME */}
                        <a href="index.html" className="inline-block bg-indigo-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-indigo-700 transition shadow-lg text-lg">
                            ‚Ü©Ô∏è Quay l·∫°i Game
                        </a>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById("root"));
        root.render(<HistoryTLMNApp />);
    </script>
</body>
</html>

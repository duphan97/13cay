<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìú L·ªãch S·ª≠ Ti·∫øn L√™n Mi·ªÅn Trung</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script> 
    <style>
        body {
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
            background-color: #f3f4f6;
        }
        
        #root {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* CƒÉn ch·ªânh hi·ªÉn th·ªã Rank Count */
        .rank-count {
            display: inline-block;
            width: 40px; /* ƒê·ªô r·ªông c·ªë ƒë·ªãnh */
            text-align: center;
            font-weight: 700;
        }
        /* ƒê√£ lo·∫°i b·ªè .final-score v√¨ kh√¥ng c√≤n d√πng t·ªïng ƒëi·ªÉm */
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;

        // --- C·∫§U H√åNH GITHUB (ƒê√É C·∫¨P NH·∫¨T) ---
        const REPO_OWNER = 'duphan97';
        const REPO_NAME = '13cay'; // ƒê√É C·∫¨P NH·∫¨T THEO Y√äU C·∫¶U
        const DATA_FILE_PATH = 'data/session_history.json'; 
        const GITHUB_API_URL = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${DATA_FILE_PATH}`;
        // --- END C·∫§U H√åNH GITHUB ---


        // --- C·∫§U H√åNH B·∫¢O M·∫¨T PBKDF2 ---
        const SECRET_PASSWORD_HASH_B64 = 'DfhK0GwpwGTAqvgGMNTYVyjjGo46w43K5Qs1h2OTqaA='; 
        const FIXED_SALT_B64 = 'WPJeEB+s7J2CPN8Mg5oTqA==';
        const ITERATIONS = 1000;
        const KEY_SIZE_WORDS = 256 / 8 / 4; 

        const hashPasswordPBKDF2 = (password) => {
            const saltWords = CryptoJS.enc.Base64.parse(FIXED_SALT_B64);
            const key = CryptoJS.PBKDF2(password, saltWords, {
                keySize: KEY_SIZE_WORDS, 
                iterations: ITERATIONS,
                hasher: CryptoJS.algo.SHA256
            });
            return key.toString(CryptoJS.enc.Base64);
        };
        // --- END C·∫§U H√åNH B·∫¢O M·∫¨T PBKDF2 ---


        // --- BASE64 AN TO√ÄN CHO UNICODE ---
        const b64ToUnicode = (str) => decodeURIComponent(
            Array.prototype.map.call(atob(str), (c) => 
                '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
            ).join('')
        );
        // --- END FIX ---


        // H√†m T·∫£i l·ªãch s·ª≠ tr·ª±c ti·∫øp t·ª´ GitHub
        const fetchHistoryFromGitHub = async () => {
            const response = await fetch(GITHUB_API_URL, {
                method: 'GET',
                headers: {
                    'Accept': 'application/vnd.github.v3+json', 
                },
            });

            if (response.status === 404) {
                return []; 
            }
            if (!response.ok) {
                throw new Error(`L·ªói t·∫£i d·ªØ li·ªáu t·ª´ GitHub: ${response.statusText}`);
            }

            const fileData = await response.json();
            
            const encodedContent = fileData.content;
            let sessionsData;
            try {
                const jsonString = b64ToUnicode(encodedContent); 
                sessionsData = JSON.parse(jsonString);
            } catch (e) {
                console.error("L·ªói Decode/Parse JSON:", e);
                // Tr·∫£ v·ªÅ m·∫£ng r·ªóng n·∫øu d·ªØ li·ªáu b·ªã l·ªói
                return []; 
            }
            
            return sessionsData; 
        };

        // --- H√ÄM T√çNH TO√ÅN T·ªîNG H·ª¢P (CH·ªà D·ª∞A V√ÄO RANK) ---
        const calculateAllTimeData = (sessions) => {
            if (!sessions || sessions.length === 0) return { scoreboard: [] };
            
            // { playerName: { 1: 0, 2: 0, 3: 0, 4: 0, totalGames: 0 } }
            const rankCountsMap = {}; 

            sessions.forEach(session => {
                // S·ª¨ D·ª§NG TR∆Ø·ªúNG 'game' TRONG C·∫§U TR√öC M·ªöI
                if (Array.isArray(session.game)) { 
                    
                    session.game.forEach(player => {
                        const rank = player.rank;
                        const playerName = player.name;
                        
                        // Initialize player data
                        rankCountsMap[playerName] = rankCountsMap[playerName] || { 1: 0, 2: 0, 3: 0, 4: 0, totalGames: 0 };
                        
                        // Aggregate Rank Counts (Ch·ªâ quan t√¢m 4 rank ƒë·∫ßu)
                        if (rank >= 1 && rank <= 4) {
                            rankCountsMap[playerName][rank]++;
                        }
                        
                        rankCountsMap[playerName].totalGames++;
                    });
                }
            });

            // Combine into a Scoreboard array
            const scoreboard = Object.keys(rankCountsMap).map(name => ({
                name,
                ranks: rankCountsMap[name],
                totalGames: rankCountsMap[name].totalGames
            }));
            
            // Logic s·∫Øp x·∫øp: ∆Øu ti√™n Rank 1 > Rank 2 > Rank 3. Rank 4 (√≠t l·∫ßn h∆°n l√† t·ªët h∆°n).
            scoreboard.sort((a, b) => {
                // 1. Rank 1: Cao h∆°n th√¨ th·∫Øng
                if (b.ranks['1'] !== a.ranks['1']) return b.ranks['1'] - a.ranks['1'];
                // 2. Rank 2: Cao h∆°n th√¨ th·∫Øng
                if (b.ranks['2'] !== a.ranks['2']) return b.ranks['2'] - a.ranks['2'];
                // 3. Rank 3: Cao h∆°n th√¨ th·∫Øng
                if (b.ranks['3'] !== a.ranks['3']) return b.ranks['3'] - a.ranks['3'];
                // 4. Rank 4: Th·∫•p h∆°n th√¨ th·∫Øng (√≠t l·∫ßn b√©t h∆°n th√¨ t·ªët h∆°n)
                if (a.ranks['4'] !== b.ranks['4']) return a.ranks['4'] - b.ranks['4'];
                // 5. Total Games: Ch∆°i nhi·ªÅu h∆°n n·∫øu ƒëi·ªÉm b·∫±ng nhau.
                return b.totalGames - a.totalGames; 
            });

            return { scoreboard };
        };
        // --- END H√ÄM T√çNH TO√ÅN T·ªîNG H·ª¢P ---

        
        // Helper cho hi·ªÉn th·ªã th·ªùi gian
        const formatSessionDate = (isoString) => {
            try {
                const date = new Date(isoString);
                return date.toLocaleDateString('vi-VN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch {
                return isoString ? isoString.substring(0, 10) : 'N/A';
            }
        };


        function HistoryTLMNApp() {
            const [sessions, setSessions] = useState(null);
            const [loading, setLoading] = useState(false);
            
            // TR·∫†NG TH√ÅI X√ÅC TH·ª∞C
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [password, setPassword] = useState('');
            const [authError, setAuthError] = useState(null);
            
            // X·ª¨ L√ù ƒêƒÇNG NH·∫¨P
            const handleLogin = async (e) => {
                e.preventDefault();
                setLoading(true);
                setAuthError(null);

                const inputHash = hashPasswordPBKDF2(password);
                
                if (inputHash === SECRET_PASSWORD_HASH_B64) {
                    try {
                        const data = await fetchHistoryFromGitHub();
                        setSessions(data);
                        setIsAuthenticated(true);
                        setPassword('');
                    } catch (err) {
                        console.error("L·ªói t·∫£i l·ªãch s·ª≠:", err.message);
                        setAuthError("ƒêƒÉng nh·∫≠p th√†nh c√¥ng nh∆∞ng l·ªói t·∫£i d·ªØ li·ªáu l·ªãch s·ª≠."); 
                    }
                } else {
                    setAuthError("M·∫≠t kh·∫©u kh√¥ng ch√≠nh x√°c. Vui l√≤ng th·ª≠ l·∫°i.");
                    setPassword('');
                }
                
                setTimeout(() => setLoading(false), 500); 
            };

            const allTimeData = useMemo(() => calculateAllTimeData(sessions), [sessions]);
            const allTimeScoreboard = allTimeData.scoreboard;

            // FIX: ƒê·∫£o ng∆∞·ª£c m·∫£ng sessions ƒë·ªÉ phi√™n m·ªõi nh·∫•t hi·ªÉn th·ªã tr∆∞·ªõc
            const reversedSessions = useMemo(() => {
                return sessions ? [...sessions].reverse() : [];
            }, [sessions]);


            // --- GIAO DI·ªÜN X√ÅC TH·ª∞C ---
            if (!isAuthenticated) {
                return (
                    <div className="flex flex-col items-center justify-center h-full min-h-[50vh] p-4">
                        <form onSubmit={handleLogin} className="w-full max-w-sm bg-white p-8 rounded-xl shadow-2xl border border-purple-200">
                            <h2 className="text-3xl font-extrabold text-center text-purple-700 mb-6">üîí Truy C·∫≠p L·ªãch S·ª≠</h2>
                            <input
                                type="password"
                                placeholder="Nh·∫≠p M·∫≠t Kh·∫©u"
                                value={password}
                                onChange={(e) => setPassword(e.target.value)}
                                className="w-full p-3 border border-gray-300 rounded-lg mb-4 text-lg focus:ring-4 focus:ring-purple-300 focus:border-purple-500 transition duration-150"
                                disabled={loading}
                                required
                            />
                            {authError && <p className="text-red-600 text-sm mb-4 text-center font-medium">{authError}</p>}
                            <button
                                type="submit"
                                className="w-full bg-purple-600 text-white font-bold text-lg py-3 rounded-lg hover:bg-purple-700 transition duration-200 disabled:bg-purple-300 shadow-md"
                                disabled={loading || !password}
                            >
                                {loading ? 'ƒêang Ki·ªÉm Tra...' : 'M·ªü L·ªãch S·ª≠'}
                            </button>
                        </form>
                    </div>
                );
            }
            
            // --- Giao di·ªán T·∫£i/L·ªói sau khi ƒêƒÉng nh·∫≠p th√†nh c√¥ng ---
            if (loading || sessions === null) {
                return (
                    <div className="text-center p-8">
                        <p className="font-semibold mb-4 text-blue-600">ƒêang t·∫£i l·ªãch s·ª≠ t·ªïng h·ª£p...</p>
                        <div className="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-500 mx-auto"></div>
                    </div>
                );
            }

            if (authError || allTimeScoreboard.length === 0) { 
                return (
                    <div className="text-center p-8 bg-yellow-100 border border-yellow-400 rounded-xl shadow-lg">
                        <p className="font-bold text-yellow-700 text-lg">üìú Ch∆∞a C√≥ D·ªØ Li·ªáu L·ªãch S·ª≠</p>
                        <p className="text-base text-gray-600 mt-2">H√£y ho√†n th√†nh m·ªôt phi√™n ch∆°i ƒë·ªÉ h·ªá th·ªëng t·ª± ƒë·ªông l∆∞u.</p>
                        <a href="index.html" className="inline-block bg-blue-500 text-white px-5 py-2 rounded-lg font-bold hover:bg-blue-600 transition mt-4 shadow-md">
                            ‚Ü©Ô∏è Quay l·∫°i Game
                        </a>
                    </div>
                );
            }

            // --- Giao di·ªán L·ªãch s·ª≠ & BXH ---
            return (
                <div>
                    <h1 className="text-3xl font-extrabold text-center text-primary mb-8">üìú L·ªãch S·ª≠ & B·∫£ng X·∫øp H·∫°ng T·ªïng H·ª£p ({sessions.length} Phi√™n)</h1>
                    
                    {/* B·∫¢NG X·∫æP H·∫†NG RANK COUNT */}
                    <div className="mb-10 p-5 bg-indigo-50 border border-indigo-200 rounded-xl shadow-xl">
                        <h2 className="text-2xl font-bold text-primary mb-4 text-center border-b pb-2">üèÜ Th·ªëng K√™ S·ªë L·∫ßn ƒê·∫°t Rank</h2>
                        
                        {/* Header c·ªßa b·∫£ng Rank Count */}
                        <div className="flex justify-between items-center px-3 py-2 text-sm font-bold text-gray-600 border-b border-gray-300 mb-2">
                            <span className="w-1/3 text-left">Ng∆∞·ªùi ch∆°i (S·ªë Game: {allTimeScoreboard[0].totalGames})</span>
                            <div className="flex w-2/3 justify-end text-center">
                                <span className="rank-count" title="S·ªë l·∫ßn ƒë·∫°t H·∫°ng 1">ü•á R1</span>
                                <span className="rank-count" title="S·ªë l·∫ßn ƒë·∫°t H·∫°ng 2">ü•à R2</span>
                                <span className="rank-count" title="S·ªë l·∫ßn ƒë·∫°t H·∫°ng 3">ü•â R3</span>
                                <span className="rank-count" title="S·ªë l·∫ßn ƒë·∫°t H·∫°ng 4">üí© R4</span>
                                {/* ƒê√£ lo·∫°i b·ªè T·ªïng ƒêi·ªÉm */}
                            </div>
                        </div>

                        <div className="space-y-2">
                            {allTimeScoreboard.map((p, index) => (
                                <div key={p.name} className={`flex justify-between items-center p-3 rounded-lg transition duration-150 ${index === 0 ? 'bg-yellow-100 font-extrabold border-l-4 border-yellow-500' : 'bg-white border hover:bg-gray-50'}`}>
                                    
                                    {/* T√™n Ng∆∞·ªùi Ch∆°i */}
                                    <span className="text-base font-semibold w-1/3 overflow-hidden text-ellipsis whitespace-nowrap">
                                        {index === 0 && 'üëë'} {p.name}
                                    </span>
                                    
                                    {/* Rank Count */}
                                    <div className="flex w-2/3 justify-end items-center">
                                        <span className="rank-count text-green-600">{p.ranks['1']}</span>
                                        <span className="rank-count text-blue-600">{p.ranks['2']}</span>
                                        <span className="rank-count text-orange-600">{p.ranks['3']}</span>
                                        <span className="rank-count text-red-600">{p.ranks['4']}</span>
                                        {/* ƒê√£ lo·∫°i b·ªè T·ªïng ƒêi·ªÉm */}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>

                    <h2 className="text-2xl font-bold text-center text-gray-700 mb-6 border-b pb-2">üìã Chi Ti·∫øt C√°c Phi√™n</h2>
                    
                    {/* DANH S√ÅCH CHI TI·∫æT C√ÅC PHI√äN */}
                    <div className="space-y-8">
                        {reversedSessions.map((session, index) => { // *** ƒê√É S·ª¨ D·ª§NG reversedSessions ***
                            
                            // S·∫Øp x·∫øp l·∫°i theo Rank (1, 2, 3, 4) ƒë·ªÉ hi·ªÉn th·ªã
                            const sortedGameResults = session.game ? [...session.game].sort((a, b) => a.rank - b.rank) : [];
                            
                            const playersCount = sortedGameResults.length;

                            return (
                                <div key={index} className="border border-gray-300 rounded-xl p-5 bg-white shadow-xl hover:shadow-2xl transition duration-200">
                                    <div className="flex justify-between items-center mb-3 border-b pb-3">
                                        <h2 className="text-xl font-bold text-gray-800">
                                            {/* C√¥ng th·ª©c ƒë√°nh s·ªë ƒë∆∞·ª£c gi·ªØ nguy√™n (t·ª´ l·ªõn nh·∫•t ƒë·∫øn 1) */}
                                            Phi√™n #{sessions.length - index}
                                        </h2>
                                        <div className="flex flex-col items-end">
                                            <span className={`text-sm font-bold px-3 py-1 rounded-full bg-green-100 text-green-800`}>
                                                {playersCount} Ng∆∞·ªùi ch∆°i
                                            </span>
                                            <p className="text-xs text-gray-500 mt-1">
                                                üóìÔ∏è <span className="font-medium">{formatSessionDate(session.timestamp)}</span>
                                            </p>
                                        </div>
                                    </div>
                                    
                                    {/* Danh s√°ch ng∆∞·ªùi ch∆°i v√† Rank cu·ªëi */}
                                    <div className="mt-2 space-y-1 text-base pt-2"> 
                                        {
                                            sortedGameResults
                                                .map(p => (
                                                <div key={p.name} className="flex justify-between items-center">
                                                    
                                                    <div className="font-semibold text-gray-800 text-base flex-grow overflow-hidden text-ellipsis whitespace-nowrap">
                                                        {p.name}
                                                    </div>
                                                    
                                                    {/* C·ªòT 2: RANK cu·ªëi (S·ª≠ d·ª•ng CSS rank-count ƒë·ªÉ cƒÉn ch·ªânh) */}
                                                    <span className={`rank-count text-base font-bold ${p.rank === 1 ? 'text-green-600' : p.rank === 4 ? 'text-red-600' : 'text-gray-700'}`}>
                                                        H·∫°ng {p.rank}
                                                    </span>
                                                </div>
                                            ))
                                        }
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                    <div className="text-center mt-8">
                        <a href="index.html" className="inline-block bg-primary text-white px-6 py-3 rounded-lg font-bold hover:bg-primary/80 transition shadow-lg text-lg">
                            ‚Ü©Ô∏è Quay l·∫°i Game
                        </a>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById("root"));
        root.render(<HistoryTLMNApp />);
    </script>
</body>
</html>

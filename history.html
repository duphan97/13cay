<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìú L·ªãch S·ª≠ Ti·∫øn L√™n Mi·ªÅn Trung</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script> 
    <style>
        body {
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
            background-color: #f3f4f6;
        }
        
        #root {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* CƒÉn ch·ªânh hi·ªÉn th·ªã Rank Count */
        .rank-count {
            display: inline-block;
            width: 35px; /* ƒê·ªô r·ªông c·ªë ƒë·ªãnh */
            text-align: center;
            font-weight: 700;
        }
        .score-badge {
            min-width: 40px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div id="root"></div>
	<script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;

        // --- C·∫§U H√åNH GITHUB ---
        const REPO_OWNER = 'duphan97';
        const REPO_NAME = '13cay'; 
        const DATA_FILE_PATH = 'data/session_history.json'; 
        const GITHUB_API_URL = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${DATA_FILE_PATH}`;
        // --- END C·∫§U H√åNH GITHUB ---


        // --- BASE64 AN TO√ÄN CHO UNICODE ---
        const b64ToUnicode = (str) => decodeURIComponent(
            Array.prototype.map.call(atob(str), (c) => 
                '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
            ).join('')
        );
        // --- END FIX ---


        // H√†m T·∫£i l·ªãch s·ª≠ tr·ª±c ti·∫øp t·ª´ GitHub
        const fetchHistoryFromGitHub = async () => {
            const response = await fetch(GITHUB_API_URL, {
                method: 'GET',
                headers: {
                    'Accept': 'application/vnd.github.v3+json', 
                },
            });

            if (response.status === 404) {
                return []; 
            }
            if (!response.ok) {
                throw new Error(`L·ªói t·∫£i d·ªØ li·ªáu t·ª´ GitHub: ${response.statusText}`);
            }

            const fileData = await response.json();
            
            const encodedContent = fileData.content;
            let sessionsData;
            try {
                const jsonString = b64ToUnicode(encodedContent); 
                sessionsData = JSON.parse(jsonString);
            } catch (e) {
                console.error("L·ªói Decode/Parse JSON:", e);
                return []; 
            }
            
            return sessionsData; 
        };

        // --- H√ÄM T√çNH TO√ÅN T·ªîNG H·ª¢P (LOGIC M·ªöI) ---
        const calculateAllTimeData = (sessions) => {
            if (!sessions || sessions.length === 0) return { scoreboard: [] };
            
            const playerStats = {}; 

            sessions.forEach(session => {
                if (Array.isArray(session.game)) { 
                    
                    // T√¨m ng∆∞·ªùi ch∆°i theo rank trong phi√™n n√†y
                    const getByRank = (r) => session.game.find(p => p.rank === r);
                    const p1 = getByRank(1);
                    const p2 = getByRank(2);
                    const p3 = getByRank(3);
                    const p4 = getByRank(4);

                    // H√†m kh·ªüi t·∫°o/c·∫≠p nh·∫≠t stat cho player
                    const updateStat = (name, rank, scoreChange) => {
                        if (!playerStats[name]) {
                            playerStats[name] = { 
                                name, 
                                ranks: { 1: 0, 2: 0, 3: 0, 4: 0 }, 
                                totalGames: 0,
                                totalScore: 0 
                            };
                        }
                        if (rank >= 1 && rank <= 4) {
                            playerStats[name].ranks[rank]++;
                        }
                        playerStats[name].totalGames++;
                        playerStats[name].totalScore += scoreChange;
                    };

                    // --- √ÅP D·ª§NG LOGIC T√çNH ƒêI·ªÇM ---
                    
                    // 1. Ng∆∞·ªùi v·ªÅ Nh·∫•t: +1 ƒëi·ªÉm
                    if (p1) updateStat(p1.name, 1, 1);

                    // 2. Ng∆∞·ªùi v·ªÅ B√©t (H·∫°ng 4): -1 ƒëi·ªÉm
                    if (p4) updateStat(p4.name, 4, -1);

                    // 3. X·ª≠ l√Ω H·∫°ng 2 v√† H·∫°ng 3
                    // M·∫∑c ƒë·ªãnh: H·∫°ng 2 (+1), H·∫°ng 3 (-1)
                    let p2Score = 1;
                    let p3Score = -1;

                    // Ki·ªÉm tra ƒëi·ªÅu ki·ªán ƒë·∫∑c bi·ªát: H·∫°ng 2 v√† 3 b·∫±ng ƒëi·ªÉm nhau -> C·∫£ hai b·ªã tr·ª´ 1
                    // L∆∞u √Ω: Ch·ªâ ki·ªÉm tra ƒë∆∞·ª£c n·∫øu trong data c√≥ l∆∞u thu·ªôc t√≠nh 'score'
                    if (p2 && p3) {
                        const hasScoreData = p2.score !== undefined && p3.score !== undefined;
                        if (hasScoreData && p2.score === p3.score) {
                            p2Score = -1; // B·ªã tr·ª´ do b·∫±ng ƒëi·ªÉm h·∫°ng 3
                            p3Score = -1;
                        }
                    }

                    if (p2) updateStat(p2.name, 2, p2Score);
                    if (p3) updateStat(p3.name, 3, p3Score);
                }
            });

            const scoreboard = Object.values(playerStats);
            
            // --- LOGIC S·∫ÆP X·∫æP M·ªöI ---
            scoreboard.sort((a, b) => {
                // 1. ∆Øu ti√™n ƒêi·ªÉm t·ªïng s·∫Øp (Cao x·∫øp tr√™n)
                if (b.totalScore !== a.totalScore) return b.totalScore - a.totalScore;
                
                // 2. N·∫øu b·∫±ng ƒëi·ªÉm, x√©t s·ªë l·∫ßn v·ªÅ Nh·∫•t
                if (b.ranks['1'] !== a.ranks['1']) return b.ranks['1'] - a.ranks['1'];
                
                // 3. X√©t s·ªë l·∫ßn v·ªÅ Nh√¨
                if (b.ranks['2'] !== a.ranks['2']) return b.ranks['2'] - a.ranks['2'];
                
                // 4. X√©t s·ªë l·∫ßn v·ªÅ Ba
                if (b.ranks['3'] !== a.ranks['3']) return b.ranks['3'] - a.ranks['3'];
                
                // 5. X√©t s·ªë l·∫ßn v·ªÅ B√©t (Th·∫•p h∆°n x·∫øp tr√™n)
                if (a.ranks['4'] !== b.ranks['4']) return a.ranks['4'] - b.ranks['4'];
                
                return b.totalGames - a.totalGames; 
            });

            return { scoreboard };
        };
        // --- END H√ÄM T√çNH TO√ÅN T·ªîNG H·ª¢P ---


        function HistoryTLMNApp() {
            const [sessions, setSessions] = useState(null);
            const [loading, setLoading] = useState(true); 
            const [dataError, setDataError] = useState(null); 
            
            useEffect(() => {
                const loadHistory = async () => {
                    setLoading(true);
                    setDataError(null);
                    try {
                        const data = await fetchHistoryFromGitHub();
                        setSessions(data);
                    } catch (err) {
                        console.error("L·ªói t·∫£i l·ªãch s·ª≠:", err.message);
                        setDataError("ƒê√£ x·∫£y ra l·ªói khi t·∫£i d·ªØ li·ªáu l·ªãch s·ª≠ t·ª´ GitHub.");
                        setSessions([]);
                    } finally {
                        setLoading(false);
                    }
                };

                loadHistory();
            }, []);

            const allTimeData = useMemo(() => calculateAllTimeData(sessions), [sessions]);
            const allTimeScoreboard = allTimeData.scoreboard;


            // --- Giao di·ªán T·∫£i/L·ªói ---
            if (loading || sessions === null) {
                return (
                    <div className="text-center p-8 min-h-[50vh] flex flex-col justify-center">
                        <p className="font-semibold mb-4 text-blue-600">ƒêang t·∫£i l·ªãch s·ª≠ t·ªïng h·ª£p...</p>
                        <div className="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-500 mx-auto"></div>
                    </div>
                );
            }

            if (dataError) {
                return (
                    <div className="text-center p-8 bg-red-100 border border-red-400 rounded-xl shadow-lg">
                        <p className="font-bold text-red-700 text-lg">‚ö†Ô∏è L·ªói T·∫£i D·ªØ Li·ªáu</p>
                        <p className="text-base text-gray-600 mt-2">{dataError}</p>
                        <a href="index.html" className="inline-block bg-indigo-500 text-white px-5 py-2 rounded-lg font-bold hover:bg-indigo-600 transition mt-4 shadow-md">
                            ‚Ü©Ô∏è Quay l·∫°i Game
                        </a>
                    </div>
                );
            }

            if (allTimeScoreboard.length === 0) { 
                return (
                    <div className="text-center p-8 bg-yellow-100 border border-yellow-400 rounded-xl shadow-lg">
                        <p className="font-bold text-yellow-700 text-lg">üìú Ch∆∞a C√≥ D·ªØ Li·ªáu L·ªãch S·ª≠</p>
                        <p className="text-base text-gray-600 mt-2">H√£y ho√†n th√†nh m·ªôt phi√™n ch∆°i ƒë·ªÉ h·ªá th·ªëng t·ª± ƒë·ªông l∆∞u.</p>
                        <a href="index.html" className="inline-block bg-indigo-500 text-white px-5 py-2 rounded-lg font-bold hover:bg-indigo-600 transition mt-4 shadow-md">
                            ‚Ü©Ô∏è Quay l·∫°i Game
                        </a>
                    </div>
                );
            }

            // --- Giao di·ªán L·ªãch s·ª≠ & BXH ---
            return (
                <div>
                    <h1 className="text-3xl font-extrabold text-center text-indigo-700 mb-8">üìú B·∫£ng X·∫øp H·∫°ng T·ªïng H·ª£p ({sessions.length} Phi√™n)</h1>
                    
                    {/* B·∫¢NG X·∫æP H·∫†NG RANK COUNT */}
                    <div className="mb-10 p-5 bg-indigo-50 border border-indigo-200 rounded-xl shadow-xl">
                        <h2 className="text-2xl font-bold text-indigo-600 mb-4 text-center border-b pb-2">üèÜ BXH T√≠nh ƒêi·ªÉm</h2>
                        
                        <div className="text-xs text-gray-500 mb-4 italic text-center">
                            (Nh·∫•t/Nh√¨: +1 ƒëi·ªÉm | Ba/B√©t: -1 ƒëi·ªÉm | Nh√¨ b·∫±ng ƒëi·ªÉm Ba: c·∫£ hai -1)
                        </div>

                        {/* Header c·ªßa b·∫£ng Rank Count */}
                        <div className="flex justify-between items-center px-3 py-2 text-sm font-bold text-gray-600 border-b border-gray-300 mb-2">
                            <span className="w-1/4 text-left">Ng∆∞·ªùi ch∆°i</span>
                            <div className="flex w-3/4 justify-end text-center items-center">
                                <span className="score-badge text-indigo-800 mr-4" title="T·ªïng ƒêi·ªÉm">‚ö° ƒêI·ªÇM</span>
                                <span className="rank-count" title="S·ªë l·∫ßn ƒë·∫°t H·∫°ng 1">ü•á</span>
                                <span className="rank-count" title="S·ªë l·∫ßn ƒë·∫°t H·∫°ng 2">ü•à</span>
                                <span className="rank-count" title="S·ªë l·∫ßn ƒë·∫°t H·∫°ng 3">ü•â</span>
                                <span className="rank-count" title="S·ªë l·∫ßn ƒë·∫°t H·∫°ng 4">üí©</span>
                            </div>
                        </div>

                        <div className="space-y-2">
                            {allTimeScoreboard.map((p, index) => (
                                <div key={p.name} className={`flex justify-between items-center p-3 rounded-lg transition duration-150 ${index === 0 ? 'bg-yellow-100 font-extrabold border-l-4 border-yellow-500' : 'bg-white border hover:bg-gray-50'}`}>
                                    
                                    {/* T√™n Ng∆∞·ªùi Ch∆°i */}
                                    <span className="text-base font-semibold w-1/4 overflow-hidden text-ellipsis whitespace-nowrap">
                                        {index === 0 && 'üëë'} {p.name}
                                    </span>
                                    
                                    {/* Score & Rank Count */}
                                    <div className="flex w-3/4 justify-end items-center">
                                        {/* Hi·ªÉn th·ªã ƒêi·ªÉm T·ªïng */}
                                        <span className={`score-badge font-bold text-lg mr-4 ${p.totalScore > 0 ? 'text-green-600' : (p.totalScore < 0 ? 'text-red-500' : 'text-gray-500')}`}>
                                            {p.totalScore > 0 ? `+${p.totalScore}` : p.totalScore}
                                        </span>

                                        <span className="rank-count text-green-600 bg-green-50 rounded py-1 mx-px">{p.ranks['1']}</span>
                                        <span className="rank-count text-blue-600 bg-blue-50 rounded py-1 mx-px">{p.ranks['2']}</span>
                                        <span className="rank-count text-orange-600 bg-orange-50 rounded py-1 mx-px">{p.ranks['3']}</span>
                                        <span className="rank-count text-red-600 bg-red-50 rounded py-1 mx-px">{p.ranks['4']}</span>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                    
                    <div className="text-center mt-8">
                        <a href="index.html" className="inline-block bg-indigo-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-indigo-700 transition shadow-lg text-lg">
                            ‚Ü©Ô∏è Quay l·∫°i Game
                        </a>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById("root"));
        root.render(<HistoryTLMNApp />);
    </script>
</body>
</html>

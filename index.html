<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöÄüìàüöÄüìàüöÄ</title>
    <link rel="icon" type="image/png" href="images/favicon.png">
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#4f46e5', // Indigo 600
                        'secondary': '#10b981', // Emerald 500
                        'warning': '#f59e0b', // Amber 500
                        'danger': '#ef4444', // Red 500
                    },
                    boxShadow: {
                        '3xl': '0 35px 60px -15px rgba(0, 0, 0, 0.3)',
                    }
                }
            }
        }
    </script>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* √Åp d·ª•ng Font Quicksand */
        body {
            font-family: 'Quicksand', sans-serif;
        }
        
        @keyframes bounce-in {
            0%, 20%, 40%, 60%, 80%, 100% {
                transition-timing-function: cubic-bezier(0.215, 0.610, 0.355, 1.000);
            }
            0% { opacity: 0; transform: scale3d(.3, .3, .3); }
            40% { transform: scale3d(1.1, 1.1, 1.1); }
            80% { transform: scale3d(.97, .97, .97); }
            100% { opacity: 1; transform: scale3d(1, 1, 1); }
        }
        .animate-bounce-in {
            animation: bounce-in 0.8s;
        }
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fade-in 0.3s ease-out;
        }
        @keyframes pulse-strong {
            0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); } /* Emerald 500 */
            50% { opacity: 0.8; box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
        }
        .animate-pulse-strong {
            animation: pulse-strong 1.5s infinite;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback, useMemo } = React;
        const MAX_PLAYERS = 4;
        
        // C·∫•u h√¨nh ƒë∆∞·ªùng d·∫´n cho √¢m thanh c·ª•c b·ªô
        const AUDIO_BASE_PATH = 'audio/';
        
        // Audio d·ª± ph√≤ng cho ng∆∞·ªùi ch∆°i t·ª± th√™m t·ª´ b√†n ph√≠m
        const FALLBACK_AUDIOS = ['member1', 'member2', 'member3', 'member4']; 

        // Danh s√°ch t√™n ng∆∞·ªùi ch∆°i c√≥ s·∫µn
        const PRESET_PLAYERS = [
            "B√¨nh ƒê·∫∑ng", 
            "D≈©ng Ho√†ng", 
            "D≈©ng Nguy·ªÖn", 
            "ƒê·ªãnh Ng√¥", 
            "ƒê√¥ng L√™", 
            "Kh√°nh ƒê·ªó", 
            "Minh Anh", 
            "Nh√¢n Tr·∫ßn", 
            "Qu√Ω Hu·ª≥nh", 
            "Tr√∫c Tr·∫ßn"
        ];
        const PRESET_ROUNDS = [15, 21, 31];
        
        // --- C·∫§U H√åNH GITHUB API ---
        const GITHUB_TOKEN_PART1 = 'github_pat_11AHU2I4Q0eTQynszWYAnj_';
        const GITHUB_TOKEN_PART2 = 'g3icOcB6W3He3EFtkB3rEuvAIst0GQQf50IaXXPDllERWI7ZWWJF0pB4QeI'; 
        const GITHUB_TOKEN = GITHUB_TOKEN_PART1 + GITHUB_TOKEN_PART2; 
        const REPO_OWNER = 'duphan97';
        const REPO_NAME = '13cay';
        const DATA_FILE_PATH = 'data/session_history.json'; 
        const GITHUB_API_URL = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${DATA_FILE_PATH}`;
        // --- H·∫æT C·∫§U H√åNH GITHUB API ---


        // --- 1. Custom Hooks & Utilities ---

        // H√†m chu·∫©n h√≥a t√™n ng∆∞·ªùi ch∆°i th√†nh t√™n file kh√¥ng d·∫•u, kh√¥ng kho·∫£ng tr·∫Øng, ch·ªØ th∆∞·ªùng
        const normalizeName = (name) => {
            return name
                .toLowerCase()
                .normalize("NFD")
                .replace(/[\u0300-\u036f]/g, "") // b·ªè d·∫•u
                .replace(/ƒë/g, 'd')             // ƒë·ªïi ƒë -> d
                .replace(/\s+/g, '');           // b·ªè kho·∫£ng tr·∫Øng
        };

        // H√†m t·∫°o ID duy nh·∫•t
        const generateId = () => Math.random().toString(36).substring(2, 9);
        
        // H√ÄM T·∫†O ƒê·ªêI T∆Ø·ª¢NG NG∆Ø·ªúI CH∆†I HO√ÄN CH·ªàNH (v·ªõi audioFile)
        const createPlayerObject = (name, isCustom = false, existingPlayers = []) => {
            const normalizedName = normalizeName(name);
            let audioFileName = normalizedName;
            
            // ID d·ª±a tr√™n t√™n chu·∫©n h√≥a + ID ng·∫´u nhi√™n ƒë·ªÉ ƒë·∫£m b·∫£o t√≠nh duy nh·∫•t
            const id = normalizedName + generateId(); 

            if (isCustom) {
                // L·ªçc ra c√°c file d·ª± ph√≤ng ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng
                const usedFallbacks = existingPlayers
                    .map(p => p.audioFile)
                    .filter(audio => FALLBACK_AUDIOS.includes(audio));
                
                // T√¨m file d·ª± ph√≤ng ƒë·∫ßu ti√™n ch∆∞a ƒë∆∞·ª£c s·ª≠ d·ª•ng
                const availableFallback = FALLBACK_AUDIOS.find(f => !usedFallbacks.includes(f));

                if (availableFallback) {
                    audioFileName = availableFallback;
                } else {
                    // N·∫øu qu√° 4 ng∆∞·ªùi ch∆°i t·ª± th√™m, quay l·∫°i d√πng t√™n chu·∫©n h√≥a (c·∫ßn file ri√™ng)
                    audioFileName = normalizedName;
                    console.warn("ƒê√£ s·ª≠ d·ª•ng h·∫øt file audio d·ª± ph√≤ng (member1-4). Ng∆∞·ªùi ch∆°i m·ªõi s·∫Ω d√πng t√™n chu·∫©n h√≥a, c·∫ßn file audio t∆∞∆°ng ·ª©ng.");
                }
            } else {
                // Ng∆∞·ªùi ch∆°i trong danh s√°ch c√≥ s·∫µn, s·ª≠ d·ª•ng t√™n chu·∫©n h√≥a
                audioFileName = normalizedName;
            }
            
            return { id, name: name.trim(), audioFile: audioFileName };
        };


        // Custom Hook: X·ª≠ l√Ω Audio theo h√†ng ƒë·ª£i
        const useAudioQueue = () => {
            const audioQueue = useRef([]); 
            const isPlaying = useRef(false); 

            const preloadAudioSequence = useCallback((soundNames) => {
                
                const loadAudioWithRetry = (name, maxRetries = 3) => {
                    if (!name || name === '') {
                        return Promise.resolve(null);
                    }
                    
                    const fullPath = `${AUDIO_BASE_PATH}${name}.mp3`;
                    const audio = new Audio(fullPath);
                    audio.volume = 0.8;
                    let attempts = 0;

                    return new Promise((resolve, reject) => {
                        const tryLoad = () => {
                            attempts++;
                            
                            if (audio.readyState >= 2) { 
                                resolve(audio);
                                return;
                            }
                            
                            const handleSuccess = () => {
                                audio.removeEventListener('error', handleError); 
                                resolve(audio);
                            };
                            
                            const handleError = (e) => {
                                audio.removeEventListener('canplaythrough', handleSuccess);
                                audio.removeEventListener('error', handleError); 
                                
                                if (attempts < maxRetries) {
                                    setTimeout(tryLoad, 500); 
                                } else {
                                    console.error(`[L·ªñI T·∫¢I FILE] Th·∫•t b·∫°i sau ${maxRetries} l·∫ßn th·ª≠ cho: ${audio.src}. B·ªè qua file.`);
                                    reject(new Error(`Failed to load ${audio.src}.`));
                                }
                            };

                            audio.addEventListener('canplaythrough', handleSuccess, { once: true });
                            audio.addEventListener('error', handleError, { once: true });
                            
                            audio.load();
                        };
                        
                        tryLoad();
                    });
                };

                const loadPromises = soundNames.map(name => loadAudioWithRetry(name).catch(e => {
                    console.warn(`T·∫£i file "${name}.mp3" th·∫•t b·∫°i, s·∫Ω b·ªè qua.`);
                    return null;
                }));


                return Promise.all(loadPromises)
                    .then(audioObjects => audioObjects.filter(obj => obj !== null))
                    .catch(error => {
                        console.warn('To√†n b·ªô chu·ªói ph√°t √¢m thanh n√†y ƒë√£ b·ªã b·ªè qua do l·ªói t·∫£i file ƒë√£ ƒë∆∞·ª£c ghi nh·∫≠n ·ªü tr√™n.');
                        return []; 
                    });

            }, []);

            const playNext = useCallback(() => {
                if (audioQueue.current.length > 0 && !isPlaying.current) {
                    isPlaying.current = true;
                    const currentSequence = audioQueue.current.shift(); 
                    let currentAudioIndex = 0;

                    const playSequence = () => {
                        if (currentAudioIndex >= currentSequence.length) {
                            isPlaying.current = false; 
                            playNext(); 
                            return;
                        }

                        const audio = currentSequence[currentAudioIndex];
                        
                        audio.onended = () => {
                            currentAudioIndex++;
                            playSequence(); 
                        };

                        audio.play().catch(e => {
                            console.warn("Autoplay was prevented or playback error:", audio.src, e);
                            currentAudioIndex++;
                            playSequence();
                        });
                    };

                    if (currentSequence.length > 0) {
                        playSequence();
                    } else {
                        isPlaying.current = false;
                        playNext();
                    }
                }
            }, []);

            const addToQueue = useCallback((soundNamesArray) => {
                const loadingPromise = preloadAudioSequence(soundNamesArray)
                    .then(preloadedAudioObjects => {
                        if (preloadedAudioObjects.length > 0) {
                            audioQueue.current.push(preloadedAudioObjects);
                        }
                    })
                    .finally(() => {
                        if (!isPlaying.current) {
                            playNext();
                        }
                    });

                return loadingPromise; 
            }, [playNext, preloadAudioSequence]);


            const addMultipleSequencesToQueue = useCallback((sequences) => {
                
                const loadingPromises = sequences.map(soundNamesArray => {
                     return preloadAudioSequence(soundNamesArray);
                });

                Promise.all(loadingPromises)
                    .then(allPreloadedSequences => {
                        allPreloadedSequences.forEach(preloadedAudioObjects => {
                            if (preloadedAudioObjects && preloadedAudioObjects.length > 0) {
                                audioQueue.current.push(preloadedAudioObjects);
                            }
                        });
                    })
                    .finally(() => {
                        if (!isPlaying.current) {
                            playNext();
                        }
                    });

            }, [playNext, preloadAudioSequence]);


            return { 
                addToQueue: addToQueue,
                addMultipleSequencesToQueue: addMultipleSequencesToQueue
            };
        };


        // Custom Hook: Qu·∫£n l√Ω State v·ªõi LocalStorage
        const useLocalStorageState = (key, defaultValue) => {
            const [state, setState] = useState(() => {
                const storedValue = localStorage.getItem(key);
                try {
                    return storedValue ? JSON.parse(storedValue) : defaultValue;
                } catch (e) {
                    console.error("L·ªói khi parse localStorage:", e);
                    return defaultValue;
                }
            });

            useEffect(() => {
                try {
                    localStorage.setItem(key, JSON.stringify(state));
                } catch (e) {
                    console.error("L·ªói khi l∆∞u v√†o localStorage:", e);
                }
            }, [key, state]);

            return [state, setState];
        };
        
        // --- Logic Ghi l·ªãch s·ª≠ l√™n GitHub (Y√™u c·∫ßu 5 & B·ªï sung ch·ªëng tr√πng l·∫∑p) ---
        const useGitHubHistory = (sortedScores, gameState, history) => { 
            const historyRef = useRef([]); 
            const shaRef = useRef(null); 
            
            // T·∫†O M·ªòT KH√ìA DUY NH·∫§T CHO TR·∫†NG TH√ÅI GAME HI·ªÜN T·∫†I (D·ª±a tr√™n t·ªïng s·ªë v√°n ƒë√£ ch∆°i)
            const currentSessionKey = `game_saved_${history.length}`;
            
            const getAndSetSha = useCallback(async () => {
                try {
                    const response = await fetch(GITHUB_API_URL, {
                        headers: {
                            'Authorization': `token ${GITHUB_TOKEN}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });

                    if (response.status === 404) {
                        // File not found, need to create it
                        shaRef.current = null;
                        return [];
                    }

                    if (!response.ok) {
                        throw new Error(`GitHub GET failed with status: ${response.status}`);
                    }

                    const data = await response.json();
                    shaRef.current = data.sha;
                    
                    // Decode content
                    const decodedContent = atob(data.content);
                    // Decode Base64 string to original UTF-8 string
                    const utf8String = decodeURIComponent(escape(decodedContent));
                    
                    const existingHistory = JSON.parse(utf8String);
                    return Array.isArray(existingHistory) ? existingHistory : [];

                } catch (error) {
                    console.error("L·ªói khi l·∫•y l·ªãch s·ª≠ t·ª´ GitHub:", error);
                    shaRef.current = null;
                    return []; 
                }
            }, []);

            const saveHistoryToGithub = useCallback(async (currentSortedScores) => {
                // KI·ªÇM TRA SESSION STORAGE TR∆Ø·ªöC KHI L∆ØU
                if (sessionStorage.getItem(currentSessionKey) === 'true') {
                    console.log("L·ªãch s·ª≠ v√°n ch∆°i n√†y ƒë√£ ƒë∆∞·ª£c l∆∞u. B·ªè qua l∆∞u GitHub.");
                    return; // NgƒÉn ch·∫∑n vi·ªác l∆∞u tr√πng l·∫∑p
                }
                
                if (!currentSortedScores || currentSortedScores.length === 0) {
                    console.log("Kh√¥ng c√≥ ƒëi·ªÉm ƒë·ªÉ l∆∞u. B·ªè qua l∆∞u GitHub.");
                    return;
                }
                
                try {
                    // 1. L·∫•y l·ªãch s·ª≠ hi·ªán t·∫°i v√† SHA
                    const existingHistory = await getAndSetSha();
                    
                    // 2. T·∫°o ƒë·ªëi t∆∞·ª£ng l·ªãch s·ª≠ m·ªõi
                    const newEntry = {
                        timestamp: new Date().toISOString(),
                        game: currentSortedScores.map((p, index) => ({
                            name: p.name,
                            rank: index + 1, // Th·ª© h·∫°ng 1, 2, 3, 4
                        }))
                    };
                    
                    const newHistory = [...existingHistory, newEntry];
                    
                    // 3. Chu·∫©n b·ªã n·ªôi dung cho API (UTF-8 v√† Base64)
                    const contentString = JSON.stringify(newHistory, null, 2);
                    
                    // Encode UTF-8 string to Base64 (H·ªó tr·ª£ ti·∫øng Vi·ªát c√≥ d·∫•u)
                    const base64Content = btoa(unescape(encodeURIComponent(contentString)));
                    
                    const payload = {
                        message: `Ho√†n t·∫•t game v√†o l√∫c ${new Date().toLocaleString('vi-VN')}`,
                        content: base64Content,
                        sha: shaRef.current, // G·ª≠i SHA n·∫øu c√≥ (update)
                    };
                    
                    const response = await fetch(GITHUB_API_URL, {
                        method: shaRef.current ? 'PUT' : 'PUT', // D√πng PUT cho c·∫£ t·∫°o m·ªõi v√† update
                        headers: {
                            'Authorization': `token ${GITHUB_TOKEN}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`GitHub PUT/POST failed with status: ${response.status}`);
                    }

                    console.log("L·ªãch s·ª≠ tr√≤ ch∆°i ƒë√£ ƒë∆∞·ª£c l∆∞u th√†nh c√¥ng l√™n GitHub!");
                    // ƒê·∫∂T C·ªú B√ÅO HI·ªÜU L∆ØU TH√ÄNH C√îNG V√ÄO SESSION STORAGE
                    sessionStorage.setItem(currentSessionKey, 'true');
                    
                    // C·∫≠p nh·∫≠t SHA m·ªõi
                    const result = await response.json();
                    shaRef.current = result.content.sha;

                } catch (error) {
                    console.error("L·ªñI C·∫§P CAO khi l∆∞u l·ªãch s·ª≠ l√™n GitHub:", error);
                    // Kh√¥ng ƒë·∫∑t c·ªù n·∫øu l∆∞u th·∫•t b·∫°i
                }
            }, [getAndSetSha, currentSessionKey]);
            
            // K√≠ch ho·∫°t vi·ªác l∆∞u khi chuy·ªÉn sang Game Over
            useEffect(() => {
                if (gameState === 'game_over' && history.length > 0) {
                    // Ch·ªâ l∆∞u khi c√≥ √≠t nh·∫•t 1 v√°n ƒë√£ ch∆°i
                    saveHistoryToGithub(sortedScores);
                }
            }, [gameState, sortedScores, saveHistoryToGithub, history.length]); 
        };

        // --- 2. Component Con: Modal (Thay th·∫ø alert/confirm) ---

        const Modal = ({ title, content, isOpen, onClose, onConfirm, confirmText = "X√°c nh·∫≠n", cancelText = "H·ªßy b·ªè", showCancel = true }) => {
            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 animate-fade-in">
                    <div className="bg-white rounded-xl shadow-3xl w-full max-w-sm animate-bounce-in">
                        <header className="px-4 py-3 bg-primary rounded-t-xl">
                            <h3 className="text-xl font-bold text-white">{title}</h3>
                        </header>
                        <div className="p-4">
                            {content}
                        </div>
                        {/* CƒÉn gi·ªØa n√∫t x√°c nh·∫≠n */}
                        <footer className="flex justify-center space-x-3 p-4 border-t border-gray-100"> 
                            {showCancel && (
                                <button
                                    onClick={onClose}
                                    className="px-4 py-2 text-sm font-semibold text-gray-700 bg-gray-200 rounded-lg transition hover:bg-gray-300"
                                >
                                    {cancelText}
                                </button>
                            )}
                            <button
                                onClick={onConfirm}
                                className="px-4 py-2 text-sm font-semibold text-white bg-secondary rounded-lg transition hover:bg-secondary/80"
                            >
                                {confirmText}
                            </button>
                        </footer>
                    </div>
                </div>
            );
        };

        // --- 3. Component Ch√≠nh: App ---

        function App() {
            // State ch√≠nh c·ªßa ·ª©ng d·ª•ng
            const [gameState, setGameState] = useLocalStorageState('gameState', 'setup'); 
            const [players, setPlayers] = useLocalStorageState('players', []);
            const [maxRounds, setMaxRounds] = useLocalStorageState('maxRounds', 15); 
            const [history, setHistory] = useLocalStorageState('history', []);
            const [showHistory, setShowHistory] = useState(false);
            const [showGameOverHistory, setShowGameOverHistory] = useState(false);
            const [isScoringMode, setIsScoringMode] = useState(false);
            const [newPlayerName, setNewPlayerName] = useState('');
            // Y√™u c·∫ßu: ƒê·∫∑t gi√° tr·ªã m·∫∑c ƒë·ªãnh cho selectedPresetPlayer l√† '' ƒë·ªÉ hi·ªÉn th·ªã option placeholder
            const [selectedPresetPlayer, setSelectedPresetPlayer] = useLocalStorageState('selectedPresetPlayer', ''); 
            const [roundScoreInputs, setRoundScoreInputs] = useLocalStorageState('roundScoreInputs', {});
            const [modal, setModal] = useState({ isOpen: false, type: null, data: null });
            const [newMaxRoundsInput, setNewMaxRoundsInput] = useState(15);
            
            const { addToQueue, addMultipleSequencesToQueue } = useAudioQueue(); 

            // T√≠nh to√°n t·ªïng ƒëi·ªÉm (Gi·ªØ nguy√™n th·ª© t·ª± ng∆∞·ªùi ch∆°i khi h·ªç ƒë∆∞·ª£c th√™m v√†o)
            const unsortedPlayerScores = useMemo(() => {
                return players.map(p => {
                    const totalScore = history.reduce((sum, round) => sum + (round.scores[p.id] || 0), 0);
                    return { ...p, totalScore: Number(totalScore) };
                }); 
            }, [players, history]);
            
            // T√≠nh to√°n B·∫£ng x·∫øp h·∫°ng ƒë·ªÉ truy·ªÅn v√†o hook GitHub
            const sortedScores = useMemo(() => {
                return [...unsortedPlayerScores].sort((a, b) => b.totalScore - a.totalScore);
            }, [unsortedPlayerScores]);

            // K√≠ch ho·∫°t Hook l∆∞u l·ªãch s·ª≠ GitHub (ƒê√£ th√™m bi·∫øn history)
            useGitHubHistory(sortedScores, gameState, history); 


            // --- Logic Audio: Ph√°t √¢m thanh ƒë·ªçc ƒëi·ªÉm V√ÅN M·ªöI ---
            const playScoreAudio = (currentRoundScores) => {
                
                // 1. T·∫°o m·∫£ng chi ti·∫øt ƒëi·ªÉm, c√≥ ƒëi·ªÉm v√°n v·ª´a ghi
                const scoreDetails = players.map(p => ({
                    ...p, // ƒê√£ bao g·ªìm audioFile
                    score: Number(currentRoundScores[p.id] || 0), 
                }));
                
                // 2. S·∫Øp x·∫øp theo ƒëi·ªÉm v√°n v·ª´a ghi (cao -> th·∫•p)
                scoreDetails.sort((a, b) => b.score - a.score);

                let allAudioSequences = [];
                
                scoreDetails.forEach(detail => {
                    // L·∫§Y FILE AUDIO ƒê√É G√ÅN (normalized name ho·∫∑c member1-4)
                    const nameFile = detail.audioFile; 
                    const scoreFile = detail.score.toString(); 

                    if (detail.score < -10 || detail.score > 10) {
                        console.warn(`[C·∫¢NH B√ÅO AUDIO V√ÅN] ƒêi·ªÉm ${detail.score} c·ªßa ${detail.name} n·∫±m ngo√†i ph·∫°m vi ƒë·ªçc (-10 ƒë·∫øn 10) th√¥ng th∆∞·ªùng. H√£y ƒë·∫£m b·∫£o c√≥ file √¢m thanh "${scoreFile}.mp3".`);
                    }

                    // Chu·ªói ph√°t m·ªõi: [T√™n ng∆∞·ªùi ch∆°i audioFile], [ƒêi·ªÉm V√ÅN V·ª™A GHI]
                    const audioSequence = [nameFile, scoreFile];
                    
                    allAudioSequences.push(audioSequence);
                });
                
                addMultipleSequencesToQueue(allAudioSequences);
            };

            // Logic Audio 6a. Ph√°t th√¥ng b√°o v√°n c√≤n l·∫°i
            const playLowRoundAudio = useCallback((roundsLeft) => {
                let audioFile = null;
                if (roundsLeft === 3) {
                    audioFile = '3left';
                } else if (roundsLeft === 2) {
                    audioFile = '2left';
                } else if (roundsLeft === 1) {
                    audioFile = '1left';
                }
                if (audioFile) {
                    addToQueue([audioFile]);
                }
            }, [addToQueue]);


            // --- 5. L·ªãch s·ª≠ ƒëi·ªÉm v√† T·ªïng k·∫øt v√°n (useEffect ch√≠nh) ---
            useEffect(() => {
                const roundsLimit = parseInt(maxRounds);
                const currentRound = history.length;
                
                if (gameState !== 'playing' || roundsLimit <= 0) return;

                const roundsLeft = roundsLimit - currentRound;
                let delayTimer = null;

                // 1. Logic Game Over - KHI ƒê·∫†T GI·ªöI H·∫†N V√ÅN
                if (currentRound >= roundsLimit) {
                    setGameState('game_over');
                    addToQueue(['gameover']); 
                    return;
                }

                // 2. Logic Low Rounds Notification
                if (currentRound > 0) { 
                    delayTimer = setTimeout(() => {
                        playLowRoundAudio(roundsLeft);
                    }, 5000); 
                }
                
                return () => {
                    if (delayTimer) {
                        clearTimeout(delayTimer);
                    }
                };
            }, [history, maxRounds, gameState, players, addToQueue, playLowRoundAudio, unsortedPlayerScores]); 
            
            useEffect(() => {
                 if (players.length > 0 && gameState === 'playing' && Object.keys(roundScoreInputs).length === 0) {
                    const initialInputs = players.reduce((acc, p) => ({ ...acc, [p.id]: 0 }), {});
                    setRoundScoreInputs(initialInputs);
                }
            }, [players, gameState, roundScoreInputs]);


            // --- 7. Ho√†n t√°c (Undo) ---
            const confirmUndo = () => {
                setHistory(prev => prev.slice(0, -1)); 
                setGameState('playing');
                setIsScoringMode(false);
                setRoundScoreInputs({});
                setModal({ isOpen: false, type: null, data: null });
                addToQueue(['hoantac']); // Y√™u c·∫ßu 2: Th√™m audio Ho√†n t√°c
                // X√≥a c·ªù sessionStorage ƒë·ªÉ cho ph√©p l∆∞u l·∫°i n·∫øu game k·∫øt th√∫c l·∫°i
                sessionStorage.removeItem(`game_saved_${history.length}`); 
            };
            
            const handleUndo = () => {
                if (history.length === 0 || isScoringMode) return;
                setModal({
                    isOpen: true,
                    type: 'confirm_action',
                    data: { action: 'Ho√†n T√°c V√°n Cu·ªëi', onConfirm: confirmUndo }
                });
            };

            // --- 8. Reset Game ---
            const confirmResetGame = () => {
                setGameState('setup');
                setPlayers([]);
                setHistory([]);
                setIsScoringMode(false);
                setRoundScoreInputs({});
                setMaxRounds(15); 
                setSelectedPresetPlayer(''); // Reset selected preset player
                localStorage.clear(); 
                // X√≥a t·∫•t c·∫£ c√°c c·ªù game_saved trong sessionStorage
                Object.keys(sessionStorage).forEach(key => {
                    if (key.startsWith('game_saved_')) {
                        sessionStorage.removeItem(key);
                    }
                });
                setModal({ isOpen: false, type: null, data: null });
            };
            
            const handleResetGame = () => {
                if (isScoringMode) return;
                setModal({
                    isOpen: true,
                    type: 'confirm_action',
                    data: { action: 'Reset Game', onConfirm: confirmResetGame }
                });
            };
            
            // --- 9. K·∫øt Th√∫c Game
             const handleEndGameConfirm = () => {
                if (isScoringMode) return;
                setModal({
                    isOpen: true,
                    type: 'confirm_action',
                    data: { 
                        action: 'K·∫øt Th√∫c Game', 
                        onConfirm: () => {
                            setGameState('game_over');
                            addToQueue(['gameover']); 
                            setModal({ isOpen: false, type: null, data: null });
                        }
                    }
                });
            };


            // --- X·ª≠ l√Ω Stage: Setup (Giai ƒëo·∫°n I) ---
            
            // Y√™u c·∫ßu 1: B·ªï sung logic Add/Remove player t·ª´ Dropdown
            const handleAddPresetPlayer = () => {
                // Ki·ªÉm tra lu√¥n c·∫£ gi√° tr·ªã '' (placeholder)
                if (!selectedPresetPlayer) return; 

                if (players.length >= MAX_PLAYERS) {
                    setModal({
                        isOpen: true,
                        type: 'info',
                        data: { title: 'Th√¥ng b√°o', message: `S·ªë l∆∞·ª£ng ng∆∞·ªùi ch∆°i t·ªëi ƒëa l√† ${MAX_PLAYERS}.` }
                    });
                    return;
                }

                const trimmedName = selectedPresetPlayer.trim();
                if (players.some(p => p.name.toLowerCase() === trimmedName.toLowerCase())) {
                    setModal({
                        isOpen: true,
                        type: 'info',
                        data: { title: 'Th√¥ng b√°o', message: `Ng∆∞·ªùi ch∆°i '${trimmedName}' ƒë√£ t·ªìn t·∫°i.` }
                    });
                    return;
                }

                // Th√™m ng∆∞·ªùi ch∆°i (lu√¥n l√† Preset, isCustom=false)
                const newPlayer = createPlayerObject(trimmedName, false, players);
                setPlayers([...players, newPlayer]);
                // Sau khi th√™m, reset l·∫°i dropdown v·ªÅ placeholder
                setSelectedPresetPlayer(''); 
            };

            const handleRemovePlayer = (playerName) => {
                const existingPlayer = players.find(p => p.name === playerName); 
                if (existingPlayer) {
                    const newPlayers = players.filter(p => p.id !== existingPlayer.id);
                    setPlayers(newPlayers);
                }
            };


            const handleAddNewPlayer = () => {
                const trimmedName = newPlayerName.trim();
                if (!trimmedName) return;

                if (players.length >= MAX_PLAYERS) {
                     setModal({
                        isOpen: true,
                        type: 'info',
                        data: { title: 'Th√¥ng b√°o', message: `S·ªë l∆∞·ª£ng ng∆∞·ªùi ch∆°i t·ªëi ƒëa l√† ${MAX_PLAYERS}.` }
                    });
                    return;
                }
                
                if (players.some(p => p.name.toLowerCase() === trimmedName.toLowerCase())) {
                     setModal({
                        isOpen: true,
                        type: 'info',
                        data: { title: 'Th√¥ng b√°o', message: `Ng∆∞·ªùi ch∆°i '${trimmedName}' ƒë√£ t·ªìn t·∫°i.` }
                    });
                    return;
                }
                
                // Th√™m ng∆∞·ªùi ch∆°i m·ªõi (isCustom=true)
                const newPlayer = createPlayerObject(trimmedName, true, players);
                setPlayers([...players, newPlayer]);
                setNewPlayerName('');
            };
            
            const handleStartGame = () => {
                if (players.length < 2) {
                    setModal({
                        isOpen: true,
                        type: 'info',
                        data: { title: 'L·ªói', message: 'C·∫ßn t·ªëi thi·ªÉu 2 ng∆∞·ªùi ch∆°i ƒë·ªÉ b·∫Øt ƒë·∫ßu tr√≤ ch∆°i.' }
                    });
                    return;
                }
                
                const finalMaxRounds = parseInt(maxRounds);
                if (isNaN(finalMaxRounds) || finalMaxRounds < 1) {
                    setModal({
                        isOpen: true,
                        type: 'info',
                        data: { title: 'L·ªói', message: 'S·ªë v√°n ch∆°i ph·∫£i l√† m·ªôt s·ªë nguy√™n d∆∞∆°ng h·ª£p l·ªá (t·ªëi thi·ªÉu 1).' }
                    });
                    setMaxRounds(15); 
                    return;
                }

                setMaxRounds(finalMaxRounds); 
                setGameState('playing');
                const initialInputs = players.reduce((acc, p) => ({ ...acc, [p.id]: 0 }), {});
                setRoundScoreInputs(initialInputs);
            };

            // --- X·ª≠ l√Ω Stage: Playing (Giai ƒëo·∫°n II) ---

            const handleNewScoreClick = () => {
                if (!isScoringMode) {
                    addToQueue(['vanmoi']); 
                    setIsScoringMode(true);
                    // D√πng unsortedPlayerScores (players) ƒë·ªÉ gi·ªØ nguy√™n th·ª© t·ª±
                    const initialInputs = unsortedPlayerScores.reduce((acc, p) => ({ ...acc, [p.id]: 0 }), {});
                    setRoundScoreInputs(initialInputs);
                } else {
                    handleConfirmScore();
                }
            };

            const handleScoreChange = (playerId, value) => {
                const numValue = value === '' ? '' : parseInt(value);
                setRoundScoreInputs(prev => ({ ...prev, [playerId]: isNaN(numValue) ? value : numValue }));
            };

            const handleConfirmScore = () => {
                const newRoundScores = {};

                // Chu·∫©n h√≥a ƒëi·ªÉm
                unsortedPlayerScores.forEach(p => {
                    const score = roundScoreInputs[p.id];
                    if (score === '' || score === null || isNaN(score)) {
                        newRoundScores[p.id] = 0; 
                    } else {
                        newRoundScores[p.id] = parseInt(score); 
                    }
                });

                // Ghi k·∫øt qu·∫£ v√†o l·ªãch s·ª≠
                const newHistoryEntry = {
                    round: history.length + 1,
                    scores: newRoundScores,
                    timestamp: new Date().toISOString()
                };
                setHistory(prev => [...prev, newHistoryEntry]);

                // Ph√°t √¢m thanh theo logic m·ªõi (s·∫Øp x·∫øp theo ƒëi·ªÉm v√°n v·ª´a ghi)
                playScoreAudio(newRoundScores);

                // Reset tr·∫°ng th√°i
                setIsScoringMode(false);
                setRoundScoreInputs({});
            };
            
            // X·ª≠ l√Ω Set Rounds - Gi·ªØ nguy√™n flow c≈© (input modal)
            const handleSetRoundsClick = () => {
                if (isScoringMode) return;
                 setModal({
                    isOpen: true,
                    type: 'reset_rounds',
                    data: { currentMax: parseInt(maxRounds) || 15, playedRounds: history.length }
                });
                setNewMaxRoundsInput(parseInt(maxRounds) || 15);
            };

            const confirmResetRounds = () => {
                const newMax = parseInt(newMaxRoundsInput);
                if (isNaN(newMax) || newMax <= 0) {
                    setModal({
                        isOpen: true,
                        type: 'info',
                        data: { title: 'L·ªói', message: 'S·ªë v√°n m·ªõi ph·∫£i l√† m·ªôt s·ªë nguy√™n d∆∞∆°ng h·ª£p l·ªá.' }
                    });
                    return;
                }
                if (newMax < history.length) {
                    setModal({
                        isOpen: true,
                        type: 'info',
                        data: { title: 'L·ªói', message: `S·ªë v√°n m·ªõi (${newMax}) kh√¥ng ƒë∆∞·ª£c nh·ªè h∆°n s·ªë v√°n ƒë√£ ch∆°i (${history.length}).` }
                    });
                    return;
                }
                
                setMaxRounds(newMax);
                setModal({ isOpen: false, type: null, data: null });
                addToQueue(['dasetsovan']); // Y√™u c·∫ßu 2: Th√™m audio Set V√°n
                
                if (history.length >= newMax) {
                    setGameState('game_over');
                    addToQueue(['gameover']); 
                }
            };

            const renderModalContent = () => {
                switch (modal.type) {
                    case 'info':
                        return <div><p className="text-gray-700">{modal.data.message}</p></div>;
                    case 'confirm_action': 
                        return <div><p className="text-gray-700 font-medium">X√°c nh·∫≠n **{modal.data.action}**?</p></div>;
                    case 'reset_rounds':
                        return (
                            <div>
                                <p className="text-gray-700 mb-4">
                                    V√°n ƒë√£ ch∆°i: <span className="font-bold text-primary">{modal.data.playedRounds}</span>.
                                    S·ªë v√°n t·ªëi thi·ªÉu ph·∫£i l√† <span className="font-bold text-primary">{modal.data.playedRounds}</span>.
                                </p>
                                <label className="block text-sm font-medium text-gray-700">Nh·∫≠p s·ªë v√°n m·ªõi:</label>
                                <input
                                    type="number"
                                    min={modal.data.playedRounds}
                                    value={newMaxRoundsInput}
                                    onChange={(e) => setNewMaxRoundsInput(e.target.value)}
                                    className="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring-primary focus:border-primary"
                                />
                            </div>
                        );
                    default:
                        return null;
                }
            };

            // --- Render c√°c Stage ---
            
            // Stage 0: Setup
            const renderSetup = () => {
                const availablePresetPlayers = PRESET_PLAYERS.filter(name => !players.some(p => p.name === name));
                
                return (
                    <div className="p-4 sm:p-6 pb-2">
                        <h2 className="text-xl font-bold text-primary mb-4 text-center">‚öôÔ∏è C·∫•u H√¨nh Tr√≤ Ch∆°i</h2>

                        {/* Ch·ªçn S·ªë V√°n */}
                        <div className="mb-4 p-4 bg-white rounded-xl shadow-lg border border-indigo-100">
                            <h3 className="text-md font-semibold mb-3 text-gray-700 flex items-center">
                                1. Ch·ªçn S·ªë V√°n Ch∆°i 
                                <span className="ml-2 px-3 py-1 text-xs font-bold text-primary bg-indigo-100 rounded-full">
                                    Hi·ªán t·∫°i: {parseInt(maxRounds) || 15}
                                </span>
                            </h3>
                            <div className="flex flex-wrap gap-2 mb-3">
                                {PRESET_ROUNDS.map(r => (
                                    <button
                                        key={r}
                                        onClick={() => setMaxRounds(r)}
                                        className={`px-3 py-1 text-sm font-medium rounded-full transition duration-200 shadow-md ${parseInt(maxRounds) === r ? 'bg-primary text-white hover:bg-primary/90' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                                    >
                                        {r} V√°n
                                    </button>
                                ))}
                            </div>
                            <input
                                type="number"
                                min="1"
                                value={maxRounds} 
                                onChange={(e) => setMaxRounds(e.target.value)} 
                                onBlur={(e) => {
                                    const val = parseInt(e.target.value);
                                    if (isNaN(val) || val < 1) {
                                        setMaxRounds(1);
                                    } else {
                                        setMaxRounds(val);
                                    }
                                }}
                                className="w-full p-2 border-2 border-gray-300 rounded-lg text-sm mt-1 focus:ring-secondary focus:border-secondary transition"
                            />
                        </div>
                        
                        {/* Ch·ªçn Ng∆∞·ªùi Ch∆°i */}
                        <div className="mb-4 p-4 bg-white rounded-xl shadow-lg border border-emerald-100">
                            <h3 className="text-md font-semibold mb-3 text-gray-700">2. Th√™m Ng∆∞·ªùi Ch∆°i</h3>
                            
                            {/* Dropdown v√† N√∫t Th√™m (Y√™u c·∫ßu: Placeholder) */}
                            <div className="flex space-x-2 mb-3">
                                <select
                                    value={selectedPresetPlayer}
                                    onChange={(e) => setSelectedPresetPlayer(e.target.value)}
                                    className="flex-grow p-2 text-sm border-2 border-gray-300 rounded-lg focus:ring-secondary focus:border-secondary disabled:bg-gray-100"
                                    disabled={players.length >= MAX_PLAYERS || availablePresetPlayers.length === 0}
                                >
                                    {/* Y√™u c·∫ßu: Placeholder cho dropdown */}
                                    <option value="" disabled className="text-gray-400">Ch·ªçn ng∆∞·ªùi ch∆°i c√≥ s·∫µn</option> 
                                    
                                    {availablePresetPlayers.length > 0 && availablePresetPlayers.map(name => (
                                        <option key={name} value={name}>{name}</option>
                                    ))}
                                    {availablePresetPlayers.length === 0 && (
                                        <option value="" disabled>Kh√¥ng c√≤n ng∆∞·ªùi ch∆°i c√≥ s·∫µn</option>
                                    )}
                                </select>
                                <button
                                    onClick={handleAddPresetPlayer}
                                    className="p-2 bg-secondary text-white rounded-lg font-semibold text-sm transition disabled:bg-gray-400 hover:bg-secondary/80"
                                    disabled={!selectedPresetPlayer || players.length >= MAX_PLAYERS || availablePresetPlayers.length === 0}
                                >
                                    Th√™m
                                </button>
                            </div>

                            {/* Th√™m ng∆∞·ªùi ch∆°i m·ªõi (T√πy ch·ªânh) */}
                            <div className="flex space-x-2 mt-3 pt-3 border-t border-gray-100">
                                <input
                                    type="text"
                                    value={newPlayerName}
                                    onChange={(e) => setNewPlayerName(e.target.value)}
                                    placeholder="T√™n ng∆∞·ªùi ch∆°i t√πy ch·ªânh..."
                                    className="flex-grow p-2 text-sm border-2 border-gray-300 rounded-lg focus:ring-primary focus:border-primary disabled:bg-gray-100"
                                    disabled={players.length >= MAX_PLAYERS}
                                />
                                <button
                                    onClick={handleAddNewPlayer}
                                    className="p-2 bg-primary text-white rounded-lg font-semibold text-sm transition disabled:bg-gray-400 hover:bg-primary/80"
                                    disabled={!newPlayerName.trim() || players.length >= MAX_PLAYERS}
                                >
                                    Th√™m
                                </button>
                            </div>
                            
                        </div>

                        {/* Danh s√°ch ng∆∞·ªùi ch∆°i ƒë√£ ch·ªçn */}
                        <div className="mb-6 p-4 bg-indigo-50 rounded-xl border border-indigo-200 shadow-inner">
                            <h3 className="text-md font-semibold text-primary mb-2">Ng∆∞·ªùi ch∆°i ƒë√£ ch·ªçn ({players.length}/{MAX_PLAYERS}):</h3>
                            <div className="flex flex-wrap gap-2">
                                {players.map(p => (
                                    <span key={p.id} className="bg-primary text-white text-xs px-3 py-1 rounded-full flex items-center font-medium shadow-sm">
                                        {p.name}
                                        <button 
                                            onClick={() => handleRemovePlayer(p.name)}
                                            className="ml-2 text-white/80 font-bold text-sm hover:text-white"
                                        >
                                            &times;
                                        </button>
                                    </span>
                                ))}
                            </div>
                            {players.length === 0 && <p className="text-sm text-gray-500 italic mt-2">Ch∆∞a c√≥ ng∆∞·ªùi ch∆°i n√†o ƒë∆∞·ª£c ch·ªçn.</p>}
                        </div>

                        {/* N√∫t B·∫Øt ƒë·∫ßu */}
                        <button
                            onClick={handleStartGame}
                            disabled={players.length < 2}
                            className="w-full py-4 bg-secondary text-white font-extrabold text-lg rounded-xl shadow-2xl transition duration-300 transform hover:scale-[1.01] disabled:bg-gray-400"
                        >
                            {players.length < 2 ? 'C·∫ßn 2 ng∆∞·ªùi ch∆°i ƒë·ªÉ b·∫Øt ƒë·∫ßu' : `B·∫ÆT ƒê·∫¶U TR√í CH∆†I (${parseInt(maxRounds) || 15} V√ÅN)`}
                        </button>
                    </div>
                );
            };


            // Stage 1: Playing
            const renderPlaying = () => (
                <div className="p-4"> 
                    <h2 className="text-2xl font-extrabold text-primary mb-3 text-center"> 
                        V√ÅN <span className="text-secondary">{history.length + 1}</span> / {parseInt(maxRounds) || 15}
                    </h2>
                    
                    {/* N√∫t Ghi/X√°c nh·∫≠n ƒëi·ªÉm (Y√™u c·∫ßu 3: Hi·ªáu ·ª©ng ƒë·ªông) */}
                     <button
                        onClick={handleNewScoreClick}
                        className={`w-full py-3 font-extrabold text-white rounded-xl shadow-xl transition duration-300 transform mb-4 
                            ${isScoringMode ? 'bg-secondary animate-pulse-strong text-lg' : 'bg-primary text-base hover:bg-primary/90'}`} 
                        disabled={unsortedPlayerScores.length === 0}
                    >
                        {isScoringMode ? `‚úÖ X√ÅC NH·∫¨N GHI ƒêI·ªÇM V√ÅN ${history.length + 1}` : 'GHI ƒêI·ªÇM V√ÅN M·ªöI'}
                    </button>
                    
                    {/* V√πng Hi·ªán Th·ªã T√™n Ng∆∞·ªùi Ch∆°i v√† Ghi ƒêi·ªÉm */}
                    <div className={`p-4 rounded-xl shadow-xl mb-4 transition duration-500 
                                     ${isScoringMode ? 'bg-indigo-50 border-4 border-indigo-200 animate-fade-in' : 'bg-white border-2 border-gray-200'}`}> 
                        <h3 className="text-xl font-bold text-gray-700 mb-3 border-b pb-2"> 
                            {isScoringMode ? '‚úèÔ∏è Nh·∫≠p ƒêi·ªÉm V√°n M·ªõi' : 'üë• Ng∆∞·ªùi Ch∆°i'}
                        </h3>
                        <div className="space-y-3"> 
                            {unsortedPlayerScores.map(p => ( 
                                <div key={p.id} className="flex justify-between items-center py-1 bg-white p-3 rounded-lg shadow-md border border-gray-100">
                                    {/* T√™n ng∆∞·ªùi ch∆°i */}
                                    <div className={`flex items-center ${isScoringMode ? 'w-1/2' : 'flex-grow'}`}>
                                        <span className={`text-lg font-bold ${isScoringMode ? 'text-gray-800' : 'text-primary'} truncate`}>
                                            {p.name}
                                        </span>
                                        {/* Y√™u c·∫ßu: B·ªè hi·ªÉn th·ªã t·ªïng ƒëi·ªÉm khi ƒëang ·ªü m√†n h√¨nh playing */}
                                        {!isScoringMode && (
                                            <span className="ml-3 text-xl font-bold text-gray-500 italic">
                                                (ƒêang ch·ªù ghi ƒëi·ªÉm)
                                            </span>
                                        )}
                                    </div>
                                    
                                    {/* Scoring Input/Controls: Ch·ªâ hi·ªÉn th·ªã n·∫øu isScoringMode l√† true */}
                                    {isScoringMode && (
                                        <div className="grid grid-cols-3 w-1/2 gap-1.5">
                                            {/* N√∫t Gi·∫£m */}
                                            <button 
                                                onClick={() => handleScoreChange(p.id, (parseInt(roundScoreInputs[p.id]) || 0) - 1)}
                                                className="p-2 bg-danger text-white rounded-xl font-extrabold text-xl transition duration-150 hover:bg-danger/80 shadow-md" 
                                            >
                                                -
                                            </button>
                                            {/* Input ƒêi·ªÉm */}
                                            <input
                                                type="number"
                                                value={roundScoreInputs[p.id] === 0 && roundScoreInputs[p.id] !== '' ? '0' : roundScoreInputs[p.id]}
                                                onChange={(e) => handleScoreChange(p.id, e.target.value)}
                                                className="p-1 border-2 border-secondary rounded-xl text-center font-mono text-xl font-bold focus:ring-secondary focus:border-secondary"
                                                placeholder="0"
                                            />
                                            {/* N√∫t TƒÉng */}
                                            <button 
                                                onClick={() => handleScoreChange(p.id, (parseInt(roundScoreInputs[p.id]) || 0) + 1)}
                                                className="p-2 bg-secondary text-white rounded-xl font-extrabold text-xl transition duration-150 hover:bg-secondary/80 shadow-md" 
                                            >
                                                +
                                            </button>
                                        </div>
                                    )}
                                </div>
                            ))}
                        </div>
                    </div>
                    
                    
                    {/* C√°c n√∫t ch·ª©c nƒÉng (4 n√∫t) */}
                    <div className="flex justify-between space-x-2 mb-4"> 
                         <button
                            onClick={handleUndo} 
                            disabled={history.length === 0 || isScoringMode}
                            className="flex-1 py-3 bg-warning text-white font-bold rounded-xl transition duration-200 disabled:bg-gray-400 text-sm hover:bg-warning/80 shadow-md"
                        >
                            ‚Ü©Ô∏è Ho√†n T√°c
                        </button>
                        <button
                            onClick={handleSetRoundsClick} 
                            disabled={isScoringMode}
                            className="flex-1 py-3 bg-blue-600 text-white font-bold rounded-xl transition duration-200 disabled:bg-gray-400 text-sm hover:bg-blue-600/80 shadow-md"
                        >
                            üîÅ Set V√°n
                        </button>
                        <button
                            onClick={handleResetGame} 
                            disabled={isScoringMode}
                            className="flex-1 py-3 bg-danger text-white font-bold rounded-xl transition duration-200 disabled:bg-gray-400 text-sm hover:bg-danger/80 shadow-md"
                        >
                            üîÑ Reset
                        </button>
                        <button
                            onClick={handleEndGameConfirm} 
                            disabled={isScoringMode}
                            className="flex-1 py-3 bg-gray-600 text-white font-bold rounded-xl transition duration-200 disabled:bg-gray-400 text-sm hover:bg-gray-600/80 shadow-md"
                        >
                            üõë K·∫øt Th√∫c
                        </button>
                    </div>
                    
                    
                    {/* L·ªãch s·ª≠ ƒëi·ªÉm */}
                    <div className="bg-white p-4 rounded-xl shadow-xl border border-gray-200"> 
                        <button 
                            onClick={() => setShowHistory(prev => !prev)}
                            className="w-full text-left text-lg font-bold text-gray-700 p-1 rounded-lg transition flex justify-between items-center hover:bg-gray-100"
                        >
                            L·ªãch S·ª≠ ƒêi·ªÉm Chi Ti·∫øt ({history.length} V√°n) {showHistory ? '‚ñ≤' : '‚ñº'}
                        </button>
                        {showHistory && (
                            <div className="overflow-x-auto mt-3 max-h-60 border rounded-lg"> 
                                <table className="min-w-full divide-y divide-gray-200">
                                    <thead className="bg-gray-100 sticky left-0 z-10">
                                        <tr>
                                            <th className="px-3 py-2 text-left text-xs font-bold text-gray-600 uppercase sticky left-0 bg-gray-100 shadow-sm min-w-[100px]">Ng∆∞·ªùi ch∆°i</th>
                                            {[...Array(history.length)].map((_, index) => (
                                                <th key={index} className="px-3 py-2 text-center text-xs font-bold text-gray-600 uppercase min-w-[50px]">V√°n {history.length - index}</th>
                                            ))}
                                        </tr>
                                    </thead>
                                    <tbody className="bg-white divide-y divide-gray-200">
                                        {players.map(p => (
                                            <tr key={p.id}>
                                                <td 
                                                    className="px-3 py-2 whitespace-nowrap text-sm font-semibold text-gray-900 sticky left-0 bg-white shadow-sm truncate" 
                                                    title={p.name}
                                                >
                                                    {p.name}
                                                </td>
                                                {[...history].reverse().map(entry => {
                                                    const score = entry.scores[p.id] || 0;
                                                    const colorClass = score > 0 ? 'text-secondary font-extrabold' : (score < 0 ? 'text-danger font-semibold' : 'text-gray-500');
                                                    return (
                                                        <td key={entry.round} className={`px-3 py-2 whitespace-nowrap text-sm text-center ${colorClass} min-w-[50px] font-mono`}>
                                                            {score > 0 ? `+${score}` : score}
                                                        </td>
                                                    );
                                                })}
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}
                    </div>
                </div>
            );

            // Stage 2: Game Over
            const renderGameOver = () => {
                // sortedScores ƒë√£ ƒë∆∞·ª£c t√≠nh to√°n ·ªü useMemo
                const playerCount = sortedScores.length;
                
                let loserScoreThreshold = null;
                if (playerCount >= 2) {
                    loserScoreThreshold = sortedScores[playerCount - 2].totalScore;
                }

                const isLoser = (p) => {
                    if (loserScoreThreshold === null) return false;
                    return p.totalScore <= loserScoreThreshold;
                };

                return (
                    // Gi·∫£m padding/margin t·ªïng th·ªÉ
                    <div className="p-4 text-center animate-bounce-in">
                        {/* Thu g·ªçn kho·∫£ng c√°ch ti√™u ƒë·ªÅ */}
                        <h2 className="text-2xl font-extrabold text-danger mb-1">üéâ TR√í CH∆†I K·∫æT TH√öC! üéâ</h2>
                        <p className="text-base font-medium text-gray-700 mb-3">T·ªïng s·ªë v√°n ƒë√£ ch∆°i: <span className="text-primary font-bold">{history.length}</span></p>

                        {/* B·∫£ng X·∫øp H·∫°ng */}
                        <div className="bg-white p-4 rounded-xl shadow-2xl mb-4 border border-indigo-200">
                            <h3 className="text-xl font-extrabold text-primary mb-3 border-b pb-2">üèÜ B·∫¢NG X·∫æP H·∫†NG</h3>
                            {sortedScores.map((p, index) => {
                                const isCurrentLoser = isLoser(p);
                                
                                // Thi·∫øt k·∫ø m·ªõi: Huy hi·ªáu v√† font to
                                const itemClassName = `flex justify-between items-center py-2 px-3 my-2 rounded-xl transition transform duration-300 shadow-md 
                                                       ${isCurrentLoser ? 'bg-red-100 border-2 border-danger scale-[1.03]' : 'bg-gray-50 border-2 border-secondary/50'}`;
                                
                                return (
                                    <div 
                                        key={p.id} 
                                        className={itemClassName}
                                    >
                                        <div className="flex items-center space-x-2">
                                            {/* Huy hi·ªáu th·ª© h·∫°ng */}
                                            <span className={`text-xl font-extrabold w-6 text-center 
                                                              ${index === 0 ? 'text-yellow-500' : index === 1 ? 'text-gray-400' : index === 2 ? 'text-amber-700' : 'text-primary'}`}>
                                                #{index + 1}
                                            </span>
                                            {/* T√™n ng∆∞·ªùi ch∆°i */}
                                            <span className={`text-lg font-bold ${isCurrentLoser ? 'text-danger' : 'text-gray-700'}`}>
                                                {p.name}
                                            </span>
                                        </div>
                                        {/* T·ªïng ƒëi·ªÉm */}
                                        <span className={`text-2xl font-extrabold ${p.totalScore >= 0 ? 'text-secondary' : 'text-danger'} font-mono`}>
                                            {p.totalScore}
                                        </span>
                                    </div>
                                );
                            })}
                        </div>

                        {/* L·ªãch s·ª≠ ƒëi·ªÉm t·∫°i m√†n h√¨nh Game Over */}
                        <div className="bg-white p-3 rounded-xl shadow-lg mb-4 border border-gray-200">
                            <button 
                                onClick={() => setShowGameOverHistory(prev => !prev)}
                                className="w-full text-left text-lg font-bold text-gray-700 p-1 rounded-lg transition flex justify-between items-center hover:bg-gray-100"
                            >
                                L·ªãch S·ª≠ ƒêi·ªÉm Chi Ti·∫øt ({history.length} V√°n) {showGameOverHistory ? '‚ñ≤' : '‚ñº'}
                            </button>
                            {showGameOverHistory && (
                                <div className="overflow-x-auto mt-2 max-h-48 border rounded-lg">
                                    <table className="min-w-full divide-y divide-gray-200">
                                        <thead className="bg-gray-100 sticky left-0 z-10">
                                            <tr>
                                                <th className="px-3 py-2 text-left text-xs font-bold text-gray-600 uppercase sticky left-0 bg-gray-100 shadow-sm min-w-[100px]">Ng∆∞·ªùi ch∆°i</th>
                                                {[...Array(history.length)].map((_, index) => (
                                                    <th key={index} className="px-3 py-2 text-center text-xs font-bold text-gray-600 uppercase min-w-[50px]">V√°n {history.length - index}</th>
                                                ))}
                                            </tr>
                                        </thead>
                                        <tbody className="bg-white divide-y divide-gray-200">
                                            {players.map(p => (
                                                <tr key={p.id}>
                                                    <td 
                                                        className="px-3 py-2 whitespace-nowrap text-sm font-semibold text-gray-900 sticky left-0 bg-white shadow-sm truncate" 
                                                        title={p.name}
                                                    >
                                                        {p.name}
                                                    </td>
                                                    {[...history].reverse().map(entry => {
                                                        const score = entry.scores[p.id] || 0;
                                                        const colorClass = score > 0 ? 'text-secondary font-extrabold' : (score < 0 ? 'text-danger font-semibold' : 'text-gray-500');
                                                        return (
                                                            <td key={entry.round} className={`px-3 py-2 whitespace-nowrap text-sm text-center ${colorClass} min-w-[50px] font-mono`}>
                                                                {score > 0 ? `+${score}` : score}
                                                            </td>
                                                        );
                                                    })}
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            )}
                        </div>

                        {/* N√∫t Ch∆°i L·∫°i */}
                        <button
                            onClick={confirmResetGame} 
                            className="w-full py-3 bg-secondary text-white font-extrabold text-xl rounded-xl shadow-xl transition hover:bg-secondary/90 transform hover:scale-[1.01]"
                        >
                            CH∆†I L·∫†I
                        </button>
                    </div>
                );
            };
            
            // --- Logic Render Ch√≠nh ---

            return (
                <div className="min-h-screen bg-gray-50 flex justify-center">
                    <div className="w-full max-w-xl mx-auto bg-white shadow-3xl rounded-2xl overflow-hidden my-0 sm:my-6">
                        <header className="bg-primary text-white p-4 text-center">
                            {/* Thay ƒë·ªïi ti√™u ƒë·ªÅ ch√≠nh */}
                            <h1 className="text-3xl font-extrabold">TI·∫æN L√äN MI·ªÄN TRUNG</h1> 
                        </header>
                        
                        {gameState === 'setup' && renderSetup()}
                        {gameState === 'playing' && renderPlaying()}
                        {gameState === 'game_over' && renderGameOver()}
                    </div>

                    {/* Modal Popup */}
                    <Modal
                        title={modal.type === 'info' ? 'Th√¥ng b√°o' : 
                               modal.type === 'confirm_action' ? 'X√°c nh·∫≠n' : 'Set l·∫°i S·ªë V√°n Ch∆°i'}
                        isOpen={modal.isOpen}
                        onClose={() => setModal({ isOpen: false, type: null, data: null })}
                        onConfirm={modal.type === 'confirm_action' ? modal.data.onConfirm : 
                                   modal.type === 'reset_rounds' ? confirmResetRounds :
                                   () => setModal({ isOpen: false, type: null, data: null }) 
                                  }
                        confirmText={modal.type === 'info' ? 'ƒê√≥ng' : 'X√°c nh·∫≠n'}
                        showCancel={modal.type !== 'info'}
                        content={renderModalContent()}
                    />
                </div>
            );
        }

        // Render ·ª©ng d·ª•ng React v√†o DOM
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>



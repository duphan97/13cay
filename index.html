<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ứng Dụng Ghi Điểm Trò Chơi</title>
    
    <!-- 1. Tailwind CSS CDN & Config -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#4f46e5', // Indigo 600
                        'secondary': '#10b981', // Emerald 500
                        'warning': '#f59e0b', // Amber 500
                        'danger': '#ef4444', // Red 500
                    },
                }
            }
        }
    </script>

    <!-- 2. React, ReactDOM, and Babel Standalone CDNs -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 3. Custom Styles for Animations -->
    <style>
        @keyframes bounce-in {
            0%, 20%, 40%, 60%, 80%, 100% {
                transition-timing-function: cubic-bezier(0.215, 0.610, 0.355, 1.000);
            }
            0% { opacity: 0; transform: scale3d(.3, .3, .3); }
            40% { transform: scale3d(1.1, 1.1, 1.1); }
            80% { transform: scale3d(.97, .97, .97); }
            100% { opacity: 1; transform: scale3d(1, 1, 1); }
        }
        .animate-bounce-in {
            animation: bounce-in 0.8s;
        }
        .animate-pulse-slow {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback, useMemo } = React;
        const MAX_PLAYERS = 4;
        
        // --- Cấu hình Audio (Sử dụng 1 âm thanh mẫu để mô phỏng) ---
        // Lưu ý: Do không thể tải file cục bộ, tôi dùng 1 file MP3 công khai ngắn (Success Chime) 
        // và dùng logic queue để mô phỏng trình tự phát âm thanh.
        const BEEP_URL = 'https://s-us-west-2.amazonaws.com/s.cdpn.io/3/success.mp3';

        // Danh sách tên người chơi có sẵn
        const PRESET_PLAYERS = ["Bình Đặng", "Dũng Hoàng", "Dũng Nguyễn", "Dự Phan", "Đông Lê"];
        const PRESET_ROUNDS = [15, 21, 31];

        // Mocks for sound mapping
        const SOUND_MOCK = {
            vanmoi: 'Ván mới!',
            dacong: 'Đã cộng',
            datru: 'Đã trừ',
            colen: 'Cố lên!',
            chiabuon: 'Chia buồn',
            va: 'và',
            dathua: 'đã thua',
            success: 'thành công'
        };

        // --- 1. Custom Hooks & Utilities ---

        // Custom Hook: Xử lý Audio theo hàng đợi (Đảm bảo không bị chồng chéo)
        const useAudioQueue = () => {
            const audioQueue = useRef([]);
            const isPlaying = useRef(false);

            const playNext = useCallback(() => {
                if (audioQueue.current.length > 0 && !isPlaying.current) {
                    isPlaying.current = true;
                    const { url, onFinished } = audioQueue.current.shift();
                    
                    const audio = new Audio(url);
                    audio.onended = () => {
                        isPlaying.current = false;
                        if (onFinished) onFinished();
                        playNext();
                    };
                    audio.onerror = () => {
                         // Fallback for errors (e.g., sound URL issue)
                        console.error("Audio playback error:", url);
                        isPlaying.current = false;
                        if (onFinished) onFinished();
                        playNext();
                    }
                    audio.play().catch(e => {
                        console.warn("Autoplay was prevented:", e);
                        isPlaying.current = false;
                        if (onFinished) onFinished();
                        playNext();
                    });
                }
            }, []);

            const addToQueue = useCallback((urls) => {
                urls.forEach(url => audioQueue.current.push({ url: BEEP_URL, onFinished: () => console.log(`[Audio Mock]: ${SOUND_MOCK[url] || url}`) }));
                if (!isPlaying.current) {
                    playNext();
                }
            }, [playNext]);

            return addToQueue;
        };

        // Custom Hook: Quản lý State với LocalStorage
        const useLocalStorageState = (key, defaultValue) => {
            const [state, setState] = useState(() => {
                const storedValue = localStorage.getItem(key);
                try {
                    return storedValue ? JSON.parse(storedValue) : defaultValue;
                } catch (e) {
                    console.error("Lỗi khi parse localStorage:", e);
                    return defaultValue;
                }
            });

            useEffect(() => {
                try {
                    localStorage.setItem(key, JSON.stringify(state));
                } catch (e) {
                    console.error("Lỗi khi lưu vào localStorage:", e);
                }
            }, [key, state]);

            return [state, setState];
        };

        // Hàm tạo ID duy nhất
        const generateId = () => Math.random().toString(36).substring(2, 9);
        
        // --- 2. Component Con: Modal (Thay thế alert/confirm) ---

        const Modal = ({ title, content, isOpen, onClose, onConfirm, confirmText = "Xác nhận", cancelText = "Hủy bỏ", showCancel = true }) => {
            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 animate-fade-in">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-sm animate-bounce-in">
                        <header className="px-4 py-3 bg-primary rounded-t-xl">
                            <h3 className="text-xl font-bold text-white">{title}</h3>
                        </header>
                        <div className="p-4">
                            {content}
                        </div>
                        <footer className="flex justify-end space-x-3 p-4 border-t border-gray-100">
                            {showCancel && (
                                <button
                                    onClick={onClose}
                                    className="px-4 py-2 text-sm font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition"
                                >
                                    {cancelText}
                                </button>
                            )}
                            <button
                                onClick={onConfirm}
                                className="px-4 py-2 text-sm font-semibold text-white bg-secondary rounded-lg hover:bg-green-600 transition"
                            >
                                {confirmText}
                            </button>
                        </footer>
                    </div>
                </div>
            );
        };

        // --- 3. Component Chính: App ---

        function App() {
            // State chính của ứng dụng
            const [gameState, setGameState] = useLocalStorageState('gameState', 'setup'); // 'setup', 'playing', 'game_over'
            const [players, setPlayers] = useLocalStorageState('players', []);
            const [maxRounds, setMaxRounds] = useLocalStorageState('maxRounds', 15);
            const [history, setHistory] = useLocalStorageState('history', []);
            const [showHistory, setShowHistory] = useState(false);
            const [isScoringMode, setIsScoringMode] = useState(false);
            const [newPlayerName, setNewPlayerName] = useState('');
            const [roundScoreInputs, setRoundScoreInputs] = useState({});
            const [modal, setModal] = useState({ isOpen: false, type: null, data: null });
            const [newMaxRoundsInput, setNewMaxRoundsInput] = useState(15);
            
            const playAudioQueue = useAudioQueue(); // Hook quản lý hàng đợi âm thanh

            // Tính toán tổng điểm và bảng xếp hạng
            const playerScores = useMemo(() => {
                return players.map(p => {
                    const totalScore = history.reduce((sum, round) => sum + (round.scores[p.id] || 0), 0);
                    return { ...p, totalScore };
                }).sort((a, b) => b.totalScore - a.totalScore); // Sắp xếp từ cao xuống thấp
            }, [players, history]);

            // --- Logic Audio 4. Phát âm thanh đọc điểm ---
            const playScoreAudio = (currentRoundScores) => {
                const scoreDetails = playerScores.map(p => ({
                    name: p.name,
                    score: currentRoundScores[p.id] || 0,
                    id: p.id
                }));
                
                // Sắp xếp theo điểm ván vừa ghi (cao -> thấp)
                scoreDetails.sort((a, b) => b.score - a.score);

                let audioSequence = [];

                scoreDetails.forEach(detail => {
                    const absScore = Math.abs(detail.score);
                    const nameFile = detail.name.replace(/\s/g, '').toLowerCase(); // Mock: Tên người chơi
                    const scoreFile = absScore.toString(); // Mock: Số điểm

                    if (detail.score > 0) {
                        // Điểm dương: dacong.mp3 + âm thanh số điểm + tennguoichoi.mp3
                        audioSequence.push('dacong', scoreFile, nameFile);
                    } else if (detail.score < 0) {
                        // Điểm âm: datru.mp3 + số điểm bị âm + tennguoichoi.mp3 + colen.mp3
                        audioSequence.push('datru', scoreFile, nameFile, 'colen');
                    } else {
                        // Điểm bằng 0: tennguoichoi.mp3 + 0.mp3 + colen.mp3
                        audioSequence.push(nameFile, '0', 'colen');
                    }
                });
                
                playAudioQueue(audioSequence);
            };

            // Logic Audio 6. Kết thúc trò chơi
            const playGameOverAudio = (sortedPlayers) => {
                if (sortedPlayers.length < 2) return;
                
                // Người ít điểm nhất là người cuối cùng trong mảng đã sắp xếp (thấp điểm)
                const lastPlayer = sortedPlayers[sortedPlayers.length - 1];
                const secondLastPlayer = sortedPlayers[sortedPlayers.length - 2];

                const audioSequence = [
                    'chiabuon', 
                    lastPlayer.name.replace(/\s/g, '').toLowerCase(), // Tên người ít điểm nhất
                    'va', 
                    secondLastPlayer.name.replace(/\s/g, '').toLowerCase(), // Tên người ít điểm tiếp theo
                    'dathua'
                ];
                
                playAudioQueue(audioSequence);
            };

            // --- 5. Lịch sử điểm và Tổng kết ván ---
            useEffect(() => {
                if (gameState === 'playing' && history.length >= maxRounds) {
                    setGameState('game_over');
                    playGameOverAudio(playerScores);
                }
            }, [history, maxRounds, gameState, playerScores]);


            // --- 7. Hoàn tác (Undo) ---
            const handleUndo = () => {
                if (history.length === 0) return;

                setModal({
                    isOpen: true,
                    type: 'confirm_undo',
                    data: { message: `Bạn có chắc chắn muốn hoàn tác Ván ${history.length} không?` }
                });
            };

            const confirmUndo = () => {
                setHistory(prev => prev.slice(0, -1)); // Xóa ván cuối cùng
                setGameState('playing');
                setIsScoringMode(false);
                setRoundScoreInputs({});
                setModal({ isOpen: false, type: null, data: null });
            };


            // --- Xử lý Stage: Setup (Giai đoạn I) ---

            const handlePlayerToggle = (player) => {
                const newPlayers = players.find(p => p.id === player.id) 
                    ? players.filter(p => p.id !== player.id)
                    : [...players, player];
                
                if (newPlayers.length > MAX_PLAYERS) {
                    setModal({
                        isOpen: true,
                        type: 'info',
                        data: { title: 'Thông báo', message: `Số lượng người chơi tối đa là ${MAX_PLAYERS}.` }
                    });
                    return;
                }
                setPlayers(newPlayers);
            };

            const handleAddNewPlayer = () => {
                if (newPlayerName && players.length < MAX_PLAYERS) {
                    const newPlayer = { id: generateId(), name: newPlayerName };
                    setPlayers([...players, newPlayer]);
                    setNewPlayerName('');
                } else if (players.length >= MAX_PLAYERS) {
                     setModal({
                        isOpen: true,
                        type: 'info',
                        data: { title: 'Thông báo', message: `Số lượng người chơi tối đa là ${MAX_PLAYERS}.` }
                    });
                }
            };
            
            const handleStartGame = () => {
                if (players.length < 2) {
                    setModal({
                        isOpen: true,
                        type: 'info',
                        data: { title: 'Lỗi', message: 'Cần tối thiểu 2 người chơi để bắt đầu trò chơi.' }
                    });
                    return;
                }
                setGameState('playing');
                // Khởi tạo các input điểm ván = 0
                const initialInputs = players.reduce((acc, p) => ({ ...acc, [p.id]: 0 }), {});
                setRoundScoreInputs(initialInputs);
            };


            // --- Xử lý Stage: Playing (Giai đoạn II) ---

            // 3. Nút “Ghi điểm ván mới”
            const handleNewScoreClick = () => {
                if (!isScoringMode) {
                    playAudioQueue(['vanmoi']);
                    setIsScoringMode(true);
                    // Reset input scores to 0 when entering scoring mode
                    const initialInputs = playerScores.reduce((acc, p) => ({ ...acc, [p.id]: 0 }), {});
                    setRoundScoreInputs(initialInputs);
                } else {
                    // Xác nhận ghi điểm
                    handleConfirmScore();
                }
            };

            const handleScoreChange = (playerId, value) => {
                const numValue = value === '' ? '' : parseInt(value);
                setRoundScoreInputs(prev => ({ ...prev, [playerId]: isNaN(numValue) ? '' : numValue }));
            };

            const handleConfirmScore = () => {
                const newRoundScores = {};
                let valid = true;

                // Chuẩn hóa và kiểm tra điểm
                playerScores.forEach(p => {
                    const score = roundScoreInputs[p.id];
                    if (score === '' || score === null || isNaN(score)) {
                        newRoundScores[p.id] = 0; // Mặc định 0 nếu để trống
                    } else {
                        newRoundScores[p.id] = score;
                    }
                });

                // Ghi kết quả vào lịch sử
                const newHistoryEntry = {
                    round: history.length + 1,
                    scores: newRoundScores,
                    timestamp: new Date().toISOString()
                };
                setHistory(prev => [...prev, newHistoryEntry]);

                // Phát âm thanh
                playScoreAudio(newRoundScores);

                // Reset trạng thái
                setIsScoringMode(false);
                setRoundScoreInputs({});
            };
            
            // 8. Set lại số ván chơi
            const handleSetRoundsClick = () => {
                 setModal({
                    isOpen: true,
                    type: 'reset_rounds',
                    data: { currentMax: maxRounds, playedRounds: history.length }
                });
                setNewMaxRoundsInput(maxRounds);
            };

            const confirmResetRounds = () => {
                const newMax = parseInt(newMaxRoundsInput);
                if (isNaN(newMax) || newMax <= 0) {
                    setModal({
                        isOpen: true,
                        type: 'info',
                        data: { title: 'Lỗi', message: 'Số ván mới phải là một số nguyên dương hợp lệ.' }
                    });
                    return;
                }
                if (newMax < history.length) {
                    setModal({
                        isOpen: true,
                        type: 'info',
                        data: { title: 'Lỗi', message: `Số ván mới (${newMax}) không được nhỏ hơn số ván đã chơi (${history.length}).` }
                    });
                    return;
                }
                setMaxRounds(newMax);
                setModal({ isOpen: false, type: null, data: null });
                if (history.length >= newMax) {
                    setGameState('game_over');
                    playGameOverAudio(playerScores);
                }
            };

            const renderModalContent = () => {
                switch (modal.type) {
                    case 'info':
                        return <div><p className="text-gray-700">{modal.data.message}</p></div>;
                    case 'confirm_undo':
                        return <div><p className="text-gray-700">{modal.data.message}</p></div>;
                    case 'reset_rounds':
                        return (
                            <div>
                                <p className="text-gray-700 mb-4">
                                    Ván đã chơi: <span className="font-bold text-primary">{modal.data.playedRounds}</span>.
                                    Số ván tối thiểu phải là <span className="font-bold text-primary">{modal.data.playedRounds + 1}</span>.
                                </p>
                                <label className="block text-sm font-medium text-gray-700">Nhập số ván mới:</label>
                                <input
                                    type="number"
                                    min={modal.data.playedRounds}
                                    value={newMaxRoundsInput}
                                    onChange={(e) => setNewMaxRoundsInput(e.target.value)}
                                    className="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring-primary focus:border-primary"
                                />
                            </div>
                        );
                    default:
                        return null;
                }
            };

            // --- Render các Stage ---
            
            // Stage 0: Setup
            const renderSetup = () => (
                <div className="p-6">
                    <h2 className="text-2xl font-bold text-primary mb-6 text-center">⚙️ Cấu Hình Trò Chơi</h2>

                    {/* Chọn Số Ván */}
                    <div className="mb-8 p-4 bg-white rounded-lg shadow">
                        <h3 className="text-lg font-semibold mb-3 text-gray-700">1. Chọn Số Ván Chơi</h3>
                        <div className="flex flex-wrap gap-2 mb-3">
                            {PRESET_ROUNDS.map(r => (
                                <button
                                    key={r}
                                    onClick={() => setMaxRounds(r)}
                                    className={`px-4 py-2 text-sm font-medium rounded-full transition ${maxRounds === r ? 'bg-primary text-white shadow-md' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                                >
                                    {r} Ván
                                </button>
                            ))}
                        </div>
                        
                        <label className="block text-sm font-medium text-gray-700 mt-4">Hoặc nhập số ván tùy chọn (Hiện tại: {maxRounds})</label>
                        <input
                            type="number"
                            min="1"
                            value={maxRounds}
                            onChange={(e) => {
                                const val = parseInt(e.target.value);
                                setMaxRounds(val > 0 ? val : 1);
                            }}
                            className="w-full p-2 border border-gray-300 rounded-lg mt-1 focus:ring-secondary focus:border-secondary"
                        />
                    </div>
                    
                    {/* Chọn Người Chơi */}
                    <div className="mb-8 p-4 bg-white rounded-lg shadow">
                        <h3 className="text-lg font-semibold mb-3 text-gray-700">2. Chọn Người Chơi (Tối đa {MAX_PLAYERS} người)</h3>
                        
                        {/* Danh sách chọn sẵn */}
                        <div className="flex flex-wrap gap-2 border-b pb-4 mb-4">
                            {PRESET_PLAYERS.map(name => {
                                const player = { id: name, name: name };
                                const isSelected = players.some(p => p.id === name);
                                return (
                                    <button
                                        key={name}
                                        onClick={() => handlePlayerToggle(player)}
                                        className={`px-3 py-1 text-sm rounded-full transition ${isSelected ? 'bg-secondary text-white font-semibold shadow-md' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'} disabled:opacity-50`}
                                        disabled={!isSelected && players.length >= MAX_PLAYERS}
                                    >
                                        {name} {isSelected ? '✅' : ''}
                                    </button>
                                );
                            })}
                        </div>

                        {/* Thêm người chơi mới */}
                        <div className="flex space-x-2">
                            <input
                                type="text"
                                value={newPlayerName}
                                onChange={(e) => setNewPlayerName(e.target.value)}
                                placeholder="Tên người chơi mới..."
                                className="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary"
                                disabled={players.length >= MAX_PLAYERS}
                            />
                            <button
                                onClick={handleAddNewPlayer}
                                className="p-2 bg-primary text-white rounded-lg font-semibold hover:bg-indigo-700 transition disabled:bg-gray-400"
                                disabled={!newPlayerName || players.length >= MAX_PLAYERS}
                            >
                                Thêm
                            </button>
                        </div>
                        {players.length >= MAX_PLAYERS && <p className="text-sm text-danger mt-1">Đã đạt tối đa {MAX_PLAYERS} người chơi.</p>}
                    </div>

                    {/* Danh sách người chơi đã chọn */}
                    <div className="mb-8 p-4 bg-indigo-50 rounded-lg border border-indigo-200">
                        <h3 className="text-lg font-semibold text-primary mb-2">Người chơi hiện tại:</h3>
                        <div className="flex flex-wrap gap-2">
                            {players.map(p => (
                                <span key={p.id} className="bg-primary text-white text-sm px-3 py-1 rounded-full flex items-center">
                                    {p.name}
                                    <button 
                                        onClick={() => handlePlayerToggle(p)}
                                        className="ml-2 text-white/80 hover:text-white font-bold text-xs"
                                    >
                                        &times;
                                    </button>
                                </span>
                            ))}
                        </div>
                        {players.length === 0 && <p className="text-sm text-gray-500 italic">Chưa có người chơi nào được chọn.</p>}
                    </div>

                    {/* Nút Bắt đầu */}
                    <button
                        onClick={handleStartGame}
                        disabled={players.length < 2}
                        className="w-full py-3 bg-secondary text-white font-bold text-xl rounded-xl shadow-lg hover:bg-green-600 transition disabled:bg-gray-400"
                    >
                        {players.length < 2 ? 'Cần 2 người chơi để bắt đầu' : `BẮT ĐẦU TRÒ CHƠI (${maxRounds} VÁN)`}
                    </button>
                </div>
            );

            // Stage 1: Playing
            const renderPlaying = () => (
                <div className="p-4 sm:p-6">
                    <h2 className="text-xl sm:text-2xl font-bold text-primary mb-4 text-center">
                        VÁN {history.length + 1} / {maxRounds}
                    </h2>
                    
                    {/* Bảng tổng điểm hiện tại (Đã loại bỏ) */}
                    
                    {/* Vùng Ghi Điểm */}
                    <div className="mb-4">
                        <button
                            onClick={handleNewScoreClick}
                            className={`w-full py-3 font-bold text-white rounded-xl shadow-lg transition duration-300 transform hover:scale-[1.01] ${isScoringMode ? 'bg-warning hover:bg-amber-600 animate-pulse-slow' : 'bg-primary hover:bg-indigo-700'}`}
                        >
                            {isScoringMode ? 'XÁC NHẬN GHI ĐIỂM VÁN NÀY' : 'GHI ĐIỂM VÁN MỚI'}
                        </button>

                        {isScoringMode && (
                            <div className="mt-4 p-4 bg-indigo-50 rounded-xl shadow border border-indigo-200 animate-fade-in">
                                <h4 className="font-semibold text-primary mb-3">Nhập điểm ván {history.length + 1}:</h4>
                                {playerScores.map(p => (
                                    <div key={p.id} className="flex items-center space-x-2 mb-3">
                                        <span className="w-1/3 text-gray-700 truncate">{p.name}:</span>
                                        <div className="flex w-2/3 space-x-1">
                                            <button 
                                                onClick={() => handleScoreChange(p.id, (roundScoreInputs[p.id] || 0) - 1)}
                                                className="p-2 bg-danger text-white rounded-lg hover:bg-red-600 font-bold"
                                            >
                                                -
                                            </button>
                                            <input
                                                type="number"
                                                value={roundScoreInputs[p.id] === 0 && roundScoreInputs[p.id] !== '' ? '0' : roundScoreInputs[p.id]}
                                                onChange={(e) => handleScoreChange(p.id, e.target.value)}
                                                className="flex-grow p-2 border border-gray-300 rounded-lg text-center font-mono"
                                                placeholder="Điểm..."
                                            />
                                            <button 
                                                onClick={() => handleScoreChange(p.id, (roundScoreInputs[p.id] || 0) + 1)}
                                                className="p-2 bg-secondary text-white rounded-lg hover:bg-green-600 font-bold"
                                            >
                                                +
                                            </button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                    
                    {/* Các nút chức năng */}
                    <div className="flex justify-between space-x-2 mb-4">
                         <button
                            onClick={handleUndo}
                            disabled={history.length === 0 || isScoringMode}
                            className="flex-1 py-2 bg-warning text-white font-semibold rounded-lg hover:bg-amber-600 transition disabled:bg-gray-400"
                        >
                            ↩️ Hoàn Tác
                        </button>
                        <button
                            onClick={handleSetRoundsClick}
                            disabled={isScoringMode}
                            className="flex-1 py-2 bg-blue-500 text-white font-semibold rounded-lg hover:bg-blue-600 transition disabled:bg-gray-400"
                        >
                            🔁 Set Ván
                        </button>
                    </div>
                    <button
                        onClick={() => setGameState('game_over')}
                        disabled={isScoringMode}
                        className="w-full py-2 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-700 transition disabled:bg-gray-400 mb-4"
                    >
                        🛑 Kết Thúc Ngay
                    </button>
                    
                    {/* Lịch sử điểm (Bảng) */}
                    <div className="bg-white p-4 rounded-xl shadow-lg">
                        <button 
                            onClick={() => setShowHistory(prev => !prev)}
                            className="w-full text-left text-lg font-semibold text-gray-700 mb-2 p-2 hover:bg-gray-100 rounded-lg transition flex justify-between items-center"
                        >
                            5. Lịch Sử Điểm ({history.length} Ván) {showHistory ? '▲' : '▼'}
                        </button>
                        {showHistory && (
                            <div className="overflow-x-auto mt-2 max-h-64">
                                <table className="min-w-full divide-y divide-gray-200">
                                    <thead className="bg-gray-50 sticky top-0">
                                        <tr>
                                            <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Ván</th>
                                            {players.map(p => (
                                                <th key={p.id} className="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase truncate" title={p.name}>{p.name}</th>
                                            ))}
                                        </tr>
                                    </thead>
                                    <tbody className="bg-white divide-y divide-gray-200">
                                        {[...history].reverse().map(entry => (
                                            <tr key={entry.round}>
                                                <td className="px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-900">{entry.round}</td>
                                                {players.map(p => {
                                                    const score = entry.scores[p.id] || 0;
                                                    const colorClass = score > 0 ? 'text-secondary font-bold' : (score < 0 ? 'text-danger' : 'text-gray-500');
                                                    return (
                                                        <td key={p.id} className={`px-3 py-2 whitespace-nowrap text-sm text-center ${colorClass}`}>
                                                            {score > 0 ? `+${score}` : score}
                                                        </td>
                                                    );
                                                })}
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}
                    </div>
                </div>
            );

            // Stage 2: Game Over
            const renderGameOver = () => (
                <div className="p-6 text-center animate-bounce-in">
                    <h2 className="text-4xl font-extrabold text-danger mb-6">🎉 TRÒ CHƠI KẾT THÚC! 🎉</h2>
                    <p className="text-xl font-medium text-gray-700 mb-8">Tổng số ván đã chơi: <span className="text-primary font-bold">{history.length}</span></p>

                    {/* Bảng Xếp Hạng */}
                    <div className="bg-white p-6 rounded-xl shadow-2xl mb-8">
                        <h3 className="text-2xl font-bold text-primary mb-4 border-b pb-2">🏆 BẢNG XẾP HẠNG</h3>
                        {playerScores.map((p, index) => (
                            <div 
                                key={p.id} 
                                className={`flex justify-between items-center py-3 px-4 my-2 rounded-lg transition transform duration-300 ${index === 0 ? 'bg-yellow-100 border-2 border-warning scale-105 shadow-lg' : 'bg-gray-50'}`}
                            >
                                <span className={`text-xl font-bold ${index === 0 ? 'text-warning' : 'text-gray-700'}`}>
                                    {index + 1}. {p.name}
                                </span>
                                <span className={`text-3xl font-extrabold ${p.totalScore >= 0 ? 'text-secondary' : 'text-danger'}`}>
                                    {p.totalScore}
                                </span>
                            </div>
                        ))}
                    </div>

                    {/* Nút Chơi Lại */}
                    <button
                        onClick={() => {
                            setGameState('setup');
                            setPlayers([]);
                            setHistory([]);
                            setIsScoringMode(false);
                            setRoundScoreInputs({});
                            setMaxRounds(15); // Reset max rounds to default
                            localStorage.clear(); // Xóa toàn bộ localStorage
                            // Note: We use window.location.reload() to fully reset the component state and localStorage
                            window.location.reload(); 
                        }}
                        className="w-full py-3 bg-secondary text-white font-bold text-xl rounded-xl shadow-lg hover:bg-green-600 transition"
                    >
                        CHƠI LẠI
                    </button>
                </div>
            );
            
            // --- Logic Render Chính ---

            return (
                <div className="min-h-screen bg-gray-50 flex justify-center">
                    <div className="w-full max-w-xl mx-auto bg-white shadow-xl rounded-2xl overflow-hidden my-4">
                        <header className="bg-primary text-white p-4 text-center">
                            <h1 className="text-3xl font-extrabold">App Ghi Điểm</h1>
                        </header>
                        
                        {gameState === 'setup' && renderSetup()}
                        {gameState === 'playing' && renderPlaying()}
                        {gameState === 'game_over' && renderGameOver()}
                    </div>

                    {/* Modal Popup */}
                    <Modal
                        title={modal.type === 'info' ? 'Thông báo' : modal.type === 'confirm_undo' ? 'Xác nhận Hoàn tác' : 'Set lại Số Ván Chơi'}
                        isOpen={modal.isOpen}
                        onClose={() => setModal({ isOpen: false, type: null, data: null })}
                        onConfirm={modal.type === 'confirm_undo' ? confirmUndo : confirmResetRounds}
                        confirmText={modal.type === 'info' ? 'Đóng' : 'Xác nhận'}
                        showCancel={modal.type !== 'info'}
                        content={renderModalContent()}
                    />
                </div>
            );
        }

        // Render ứng dụng React vào DOM
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

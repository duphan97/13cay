<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>·ª®ng D·ª•ng Ghi ƒêi·ªÉm Tr√≤ Ch∆°i</title>
    
    <!-- 1. Tailwind CSS CDN & Config -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#4f46e5', // Indigo 600
                        'secondary': '#10b981', // Emerald 500
                        'warning': '#f59e0b', // Amber 500
                        'danger': '#ef4444', // Red 500
                    },
                }
            }
        }
    </script>

    <!-- 2. React, ReactDOM, and Babel Standalone CDNs -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 3. Custom Styles for Animations -->
    <style>
        @keyframes bounce-in {
            0%, 20%, 40%, 60%, 80%, 100% {
                transition-timing-function: cubic-bezier(0.215, 0.610, 0.355, 1.000);
            }
            0% { opacity: 0; transform: scale3d(.3, .3, .3); }
            40% { transform: scale3d(1.1, 1.1, 1.1); }
            80% { transform: scale3d(.97, .97, .97); }
            100% { opacity: 1; transform: scale3d(1, 1, 1); }
        }
        .animate-bounce-in {
            animation: bounce-in 0.8s;
        }
        .animate-pulse-slow {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback, useMemo } = React;
        const MAX_PLAYERS = 4;
        
        // --- C·∫•u h√¨nh Audio (S·ª≠ d·ª•ng 1 √¢m thanh m·∫´u ƒë·ªÉ m√¥ ph·ªèng) ---
        // L∆∞u √Ω: Do kh√¥ng th·ªÉ t·∫£i file c·ª•c b·ªô, t√¥i d√πng 1 file MP3 c√¥ng khai ng·∫Øn (Success Chime) 
        // v√† d√πng logic queue ƒë·ªÉ m√¥ ph·ªèng tr√¨nh t·ª± ph√°t √¢m thanh.
        const BEEP_URL = 'https://s-us-west-2.amazonaws.com/s.cdpn.io/3/success.mp3';

        // Danh s√°ch t√™n ng∆∞·ªùi ch∆°i c√≥ s·∫µn
        const PRESET_PLAYERS = ["B√¨nh ƒê·∫∑ng", "D≈©ng Ho√†ng", "D≈©ng Nguy·ªÖn", "D·ª± Phan", "ƒê√¥ng L√™"];
        const PRESET_ROUNDS = [15, 21, 31];

        // Mocks for sound mapping
        const SOUND_MOCK = {
            vanmoi: 'V√°n m·ªõi!',
            dacong: 'ƒê√£ c·ªông',
            datru: 'ƒê√£ tr·ª´',
            colen: 'C·ªë l√™n!',
            chiabuon: 'Chia bu·ªìn',
            va: 'v√†',
            dathua: 'ƒë√£ thua',
            success: 'th√†nh c√¥ng'
        };

        // --- 1. Custom Hooks & Utilities ---

        // Custom Hook: X·ª≠ l√Ω Audio theo h√†ng ƒë·ª£i (ƒê·∫£m b·∫£o kh√¥ng b·ªã ch·ªìng ch√©o)
        const useAudioQueue = () => {
            const audioQueue = useRef([]);
            const isPlaying = useRef(false);

            const playNext = useCallback(() => {
                if (audioQueue.current.length > 0 && !isPlaying.current) {
                    isPlaying.current = true;
                    const { url, onFinished } = audioQueue.current.shift();
                    
                    const audio = new Audio(url);
                    audio.onended = () => {
                        isPlaying.current = false;
                        if (onFinished) onFinished();
                        playNext();
                    };
                    audio.onerror = () => {
                         // Fallback for errors (e.g., sound URL issue)
                        console.error("Audio playback error:", url);
                        isPlaying.current = false;
                        if (onFinished) onFinished();
                        playNext();
                    }
                    audio.play().catch(e => {
                        console.warn("Autoplay was prevented:", e);
                        isPlaying.current = false;
                        if (onFinished) onFinished();
                        playNext();
                    });
                }
            }, []);

            const addToQueue = useCallback((urls) => {
                urls.forEach(url => audioQueue.current.push({ url: BEEP_URL, onFinished: () => console.log(`[Audio Mock]: ${SOUND_MOCK[url] || url}`) }));
                if (!isPlaying.current) {
                    playNext();
                }
            }, [playNext]);

            return addToQueue;
        };

        // Custom Hook: Qu·∫£n l√Ω State v·ªõi LocalStorage
        const useLocalStorageState = (key, defaultValue) => {
            const [state, setState] = useState(() => {
                const storedValue = localStorage.getItem(key);
                try {
                    return storedValue ? JSON.parse(storedValue) : defaultValue;
                } catch (e) {
                    console.error("L·ªói khi parse localStorage:", e);
                    return defaultValue;
                }
            });

            useEffect(() => {
                try {
                    localStorage.setItem(key, JSON.stringify(state));
                } catch (e) {
                    console.error("L·ªói khi l∆∞u v√†o localStorage:", e);
                }
            }, [key, state]);

            return [state, setState];
        };

        // H√†m t·∫°o ID duy nh·∫•t
        const generateId = () => Math.random().toString(36).substring(2, 9);
        
        // --- 2. Component Con: Modal (Thay th·∫ø alert/confirm) ---

        const Modal = ({ title, content, isOpen, onClose, onConfirm, confirmText = "X√°c nh·∫≠n", cancelText = "H·ªßy b·ªè", showCancel = true }) => {
            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 animate-fade-in">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-sm animate-bounce-in">
                        <header className="px-4 py-3 bg-primary rounded-t-xl">
                            <h3 className="text-xl font-bold text-white">{title}</h3>
                        </header>
                        <div className="p-4">
                            {content}
                        </div>
                        <footer className="flex justify-end space-x-3 p-4 border-t border-gray-100">
                            {showCancel && (
                                <button
                                    onClick={onClose}
                                    className="px-4 py-2 text-sm font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition"
                                >
                                    {cancelText}
                                </button>
                            )}
                            <button
                                onClick={onConfirm}
                                className="px-4 py-2 text-sm font-semibold text-white bg-secondary rounded-lg hover:bg-green-600 transition"
                            >
                                {confirmText}
                            </button>
                        </footer>
                    </div>
                </div>
            );
        };

        // --- 3. Component Ch√≠nh: App ---

        function App() {
            // State ch√≠nh c·ªßa ·ª©ng d·ª•ng
            const [gameState, setGameState] = useLocalStorageState('gameState', 'setup'); // 'setup', 'playing', 'game_over'
            const [players, setPlayers] = useLocalStorageState('players', []);
            const [maxRounds, setMaxRounds] = useLocalStorageState('maxRounds', 15);
            const [history, setHistory] = useLocalStorageState('history', []);
            const [showHistory, setShowHistory] = useState(false);
            const [isScoringMode, setIsScoringMode] = useState(false);
            const [newPlayerName, setNewPlayerName] = useState('');
            const [roundScoreInputs, setRoundScoreInputs] = useState({});
            const [modal, setModal] = useState({ isOpen: false, type: null, data: null });
            const [newMaxRoundsInput, setNewMaxRoundsInput] = useState(15);
            
            const playAudioQueue = useAudioQueue(); // Hook qu·∫£n l√Ω h√†ng ƒë·ª£i √¢m thanh

            // T√≠nh to√°n t·ªïng ƒëi·ªÉm v√† b·∫£ng x·∫øp h·∫°ng
            const playerScores = useMemo(() => {
                return players.map(p => {
                    const totalScore = history.reduce((sum, round) => sum + (round.scores[p.id] || 0), 0);
                    return { ...p, totalScore };
                }).sort((a, b) => b.totalScore - a.totalScore); // S·∫Øp x·∫øp t·ª´ cao xu·ªëng th·∫•p
            }, [players, history]);

            // --- Logic Audio 4. Ph√°t √¢m thanh ƒë·ªçc ƒëi·ªÉm ---
            const playScoreAudio = (currentRoundScores) => {
                const scoreDetails = playerScores.map(p => ({
                    name: p.name,
                    score: currentRoundScores[p.id] || 0,
                    id: p.id
                }));
                
                // S·∫Øp x·∫øp theo ƒëi·ªÉm v√°n v·ª´a ghi (cao -> th·∫•p)
                scoreDetails.sort((a, b) => b.score - a.score);

                let audioSequence = [];

                scoreDetails.forEach(detail => {
                    const absScore = Math.abs(detail.score);
                    const nameFile = detail.name.replace(/\s/g, '').toLowerCase(); // Mock: T√™n ng∆∞·ªùi ch∆°i
                    const scoreFile = absScore.toString(); // Mock: S·ªë ƒëi·ªÉm

                    if (detail.score > 0) {
                        // ƒêi·ªÉm d∆∞∆°ng: dacong.mp3 + √¢m thanh s·ªë ƒëi·ªÉm + tennguoichoi.mp3
                        audioSequence.push('dacong', scoreFile, nameFile);
                    } else if (detail.score < 0) {
                        // ƒêi·ªÉm √¢m: datru.mp3 + s·ªë ƒëi·ªÉm b·ªã √¢m + tennguoichoi.mp3 + colen.mp3
                        audioSequence.push('datru', scoreFile, nameFile, 'colen');
                    } else {
                        // ƒêi·ªÉm b·∫±ng 0: tennguoichoi.mp3 + 0.mp3 + colen.mp3
                        audioSequence.push(nameFile, '0', 'colen');
                    }
                });
                
                playAudioQueue(audioSequence);
            };

            // Logic Audio 6. K·∫øt th√∫c tr√≤ ch∆°i
            const playGameOverAudio = (sortedPlayers) => {
                if (sortedPlayers.length < 2) return;
                
                // Ng∆∞·ªùi √≠t ƒëi·ªÉm nh·∫•t l√† ng∆∞·ªùi cu·ªëi c√πng trong m·∫£ng ƒë√£ s·∫Øp x·∫øp (th·∫•p ƒëi·ªÉm)
                const lastPlayer = sortedPlayers[sortedPlayers.length - 1];
                const secondLastPlayer = sortedPlayers[sortedPlayers.length - 2];

                const audioSequence = [
                    'chiabuon', 
                    lastPlayer.name.replace(/\s/g, '').toLowerCase(), // T√™n ng∆∞·ªùi √≠t ƒëi·ªÉm nh·∫•t
                    'va', 
                    secondLastPlayer.name.replace(/\s/g, '').toLowerCase(), // T√™n ng∆∞·ªùi √≠t ƒëi·ªÉm ti·∫øp theo
                    'dathua'
                ];
                
                playAudioQueue(audioSequence);
            };

            // --- 5. L·ªãch s·ª≠ ƒëi·ªÉm v√† T·ªïng k·∫øt v√°n ---
            useEffect(() => {
                if (gameState === 'playing' && history.length >= maxRounds) {
                    setGameState('game_over');
                    playGameOverAudio(playerScores);
                }
            }, [history, maxRounds, gameState, playerScores]);


            // --- 7. Ho√†n t√°c (Undo) ---
            const handleUndo = () => {
                if (history.length === 0) return;

                setModal({
                    isOpen: true,
                    type: 'confirm_undo',
                    data: { message: `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ho√†n t√°c V√°n ${history.length} kh√¥ng?` }
                });
            };

            const confirmUndo = () => {
                setHistory(prev => prev.slice(0, -1)); // X√≥a v√°n cu·ªëi c√πng
                setGameState('playing');
                setIsScoringMode(false);
                setRoundScoreInputs({});
                setModal({ isOpen: false, type: null, data: null });
            };


            // --- X·ª≠ l√Ω Stage: Setup (Giai ƒëo·∫°n I) ---

            const handlePlayerToggle = (player) => {
                const newPlayers = players.find(p => p.id === player.id) 
                    ? players.filter(p => p.id !== player.id)
                    : [...players, player];
                
                if (newPlayers.length > MAX_PLAYERS) {
                    setModal({
                        isOpen: true,
                        type: 'info',
                        data: { title: 'Th√¥ng b√°o', message: `S·ªë l∆∞·ª£ng ng∆∞·ªùi ch∆°i t·ªëi ƒëa l√† ${MAX_PLAYERS}.` }
                    });
                    return;
                }
                setPlayers(newPlayers);
            };

            const handleAddNewPlayer = () => {
                if (newPlayerName && players.length < MAX_PLAYERS) {
                    const newPlayer = { id: generateId(), name: newPlayerName };
                    setPlayers([...players, newPlayer]);
                    setNewPlayerName('');
                } else if (players.length >= MAX_PLAYERS) {
                     setModal({
                        isOpen: true,
                        type: 'info',
                        data: { title: 'Th√¥ng b√°o', message: `S·ªë l∆∞·ª£ng ng∆∞·ªùi ch∆°i t·ªëi ƒëa l√† ${MAX_PLAYERS}.` }
                    });
                }
            };
            
            const handleStartGame = () => {
                if (players.length < 2) {
                    setModal({
                        isOpen: true,
                        type: 'info',
                        data: { title: 'L·ªói', message: 'C·∫ßn t·ªëi thi·ªÉu 2 ng∆∞·ªùi ch∆°i ƒë·ªÉ b·∫Øt ƒë·∫ßu tr√≤ ch∆°i.' }
                    });
                    return;
                }
                setGameState('playing');
                // Kh·ªüi t·∫°o c√°c input ƒëi·ªÉm v√°n = 0
                const initialInputs = players.reduce((acc, p) => ({ ...acc, [p.id]: 0 }), {});
                setRoundScoreInputs(initialInputs);
            };


            // --- X·ª≠ l√Ω Stage: Playing (Giai ƒëo·∫°n II) ---

            // 3. N√∫t ‚ÄúGhi ƒëi·ªÉm v√°n m·ªõi‚Äù
            const handleNewScoreClick = () => {
                if (!isScoringMode) {
                    playAudioQueue(['vanmoi']);
                    setIsScoringMode(true);
                    // Reset input scores to 0 when entering scoring mode
                    const initialInputs = playerScores.reduce((acc, p) => ({ ...acc, [p.id]: 0 }), {});
                    setRoundScoreInputs(initialInputs);
                } else {
                    // X√°c nh·∫≠n ghi ƒëi·ªÉm
                    handleConfirmScore();
                }
            };

            const handleScoreChange = (playerId, value) => {
                const numValue = value === '' ? '' : parseInt(value);
                setRoundScoreInputs(prev => ({ ...prev, [playerId]: isNaN(numValue) ? '' : numValue }));
            };

            const handleConfirmScore = () => {
                const newRoundScores = {};
                let valid = true;

                // Chu·∫©n h√≥a v√† ki·ªÉm tra ƒëi·ªÉm
                playerScores.forEach(p => {
                    const score = roundScoreInputs[p.id];
                    if (score === '' || score === null || isNaN(score)) {
                        newRoundScores[p.id] = 0; // M·∫∑c ƒë·ªãnh 0 n·∫øu ƒë·ªÉ tr·ªëng
                    } else {
                        newRoundScores[p.id] = score;
                    }
                });

                // Ghi k·∫øt qu·∫£ v√†o l·ªãch s·ª≠
                const newHistoryEntry = {
                    round: history.length + 1,
                    scores: newRoundScores,
                    timestamp: new Date().toISOString()
                };
                setHistory(prev => [...prev, newHistoryEntry]);

                // Ph√°t √¢m thanh
                playScoreAudio(newRoundScores);

                // Reset tr·∫°ng th√°i
                setIsScoringMode(false);
                setRoundScoreInputs({});
            };
            
            // 8. Set l·∫°i s·ªë v√°n ch∆°i
            const handleSetRoundsClick = () => {
                 setModal({
                    isOpen: true,
                    type: 'reset_rounds',
                    data: { currentMax: maxRounds, playedRounds: history.length }
                });
                setNewMaxRoundsInput(maxRounds);
            };

            const confirmResetRounds = () => {
                const newMax = parseInt(newMaxRoundsInput);
                if (isNaN(newMax) || newMax <= 0) {
                    setModal({
                        isOpen: true,
                        type: 'info',
                        data: { title: 'L·ªói', message: 'S·ªë v√°n m·ªõi ph·∫£i l√† m·ªôt s·ªë nguy√™n d∆∞∆°ng h·ª£p l·ªá.' }
                    });
                    return;
                }
                if (newMax < history.length) {
                    setModal({
                        isOpen: true,
                        type: 'info',
                        data: { title: 'L·ªói', message: `S·ªë v√°n m·ªõi (${newMax}) kh√¥ng ƒë∆∞·ª£c nh·ªè h∆°n s·ªë v√°n ƒë√£ ch∆°i (${history.length}).` }
                    });
                    return;
                }
                setMaxRounds(newMax);
                setModal({ isOpen: false, type: null, data: null });
                if (history.length >= newMax) {
                    setGameState('game_over');
                    playGameOverAudio(playerScores);
                }
            };

            const renderModalContent = () => {
                switch (modal.type) {
                    case 'info':
                        return <div><p className="text-gray-700">{modal.data.message}</p></div>;
                    case 'confirm_undo':
                        return <div><p className="text-gray-700">{modal.data.message}</p></div>;
                    case 'reset_rounds':
                        return (
                            <div>
                                <p className="text-gray-700 mb-4">
                                    V√°n ƒë√£ ch∆°i: <span className="font-bold text-primary">{modal.data.playedRounds}</span>.
                                    S·ªë v√°n t·ªëi thi·ªÉu ph·∫£i l√† <span className="font-bold text-primary">{modal.data.playedRounds + 1}</span>.
                                </p>
                                <label className="block text-sm font-medium text-gray-700">Nh·∫≠p s·ªë v√°n m·ªõi:</label>
                                <input
                                    type="number"
                                    min={modal.data.playedRounds}
                                    value={newMaxRoundsInput}
                                    onChange={(e) => setNewMaxRoundsInput(e.target.value)}
                                    className="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring-primary focus:border-primary"
                                />
                            </div>
                        );
                    default:
                        return null;
                }
            };

            // --- Render c√°c Stage ---
            
            // Stage 0: Setup
            const renderSetup = () => (
                <div className="p-6">
                    <h2 className="text-2xl font-bold text-primary mb-6 text-center">‚öôÔ∏è C·∫•u H√¨nh Tr√≤ Ch∆°i</h2>

                    {/* Ch·ªçn S·ªë V√°n */}
                    <div className="mb-8 p-4 bg-white rounded-lg shadow">
                        <h3 className="text-lg font-semibold mb-3 text-gray-700">1. Ch·ªçn S·ªë V√°n Ch∆°i</h3>
                        <div className="flex flex-wrap gap-2 mb-3">
                            {PRESET_ROUNDS.map(r => (
                                <button
                                    key={r}
                                    onClick={() => setMaxRounds(r)}
                                    className={`px-4 py-2 text-sm font-medium rounded-full transition ${maxRounds === r ? 'bg-primary text-white shadow-md' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                                >
                                    {r} V√°n
                                </button>
                            ))}
                        </div>
                        
                        <label className="block text-sm font-medium text-gray-700 mt-4">Ho·∫∑c nh·∫≠p s·ªë v√°n t√πy ch·ªçn (Hi·ªán t·∫°i: {maxRounds})</label>
                        <input
                            type="number"
                            min="1"
                            value={maxRounds}
                            onChange={(e) => {
                                const val = parseInt(e.target.value);
                                setMaxRounds(val > 0 ? val : 1);
                            }}
                            className="w-full p-2 border border-gray-300 rounded-lg mt-1 focus:ring-secondary focus:border-secondary"
                        />
                    </div>
                    
                    {/* Ch·ªçn Ng∆∞·ªùi Ch∆°i */}
                    <div className="mb-8 p-4 bg-white rounded-lg shadow">
                        <h3 className="text-lg font-semibold mb-3 text-gray-700">2. Ch·ªçn Ng∆∞·ªùi Ch∆°i (T·ªëi ƒëa {MAX_PLAYERS} ng∆∞·ªùi)</h3>
                        
                        {/* Danh s√°ch ch·ªçn s·∫µn */}
                        <div className="flex flex-wrap gap-2 border-b pb-4 mb-4">
                            {PRESET_PLAYERS.map(name => {
                                const player = { id: name, name: name };
                                const isSelected = players.some(p => p.id === name);
                                return (
                                    <button
                                        key={name}
                                        onClick={() => handlePlayerToggle(player)}
                                        className={`px-3 py-1 text-sm rounded-full transition ${isSelected ? 'bg-secondary text-white font-semibold shadow-md' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'} disabled:opacity-50`}
                                        disabled={!isSelected && players.length >= MAX_PLAYERS}
                                    >
                                        {name} {isSelected ? '‚úÖ' : ''}
                                    </button>
                                );
                            })}
                        </div>

                        {/* Th√™m ng∆∞·ªùi ch∆°i m·ªõi */}
                        <div className="flex space-x-2">
                            <input
                                type="text"
                                value={newPlayerName}
                                onChange={(e) => setNewPlayerName(e.target.value)}
                                placeholder="T√™n ng∆∞·ªùi ch∆°i m·ªõi..."
                                className="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary"
                                disabled={players.length >= MAX_PLAYERS}
                            />
                            <button
                                onClick={handleAddNewPlayer}
                                className="p-2 bg-primary text-white rounded-lg font-semibold hover:bg-indigo-700 transition disabled:bg-gray-400"
                                disabled={!newPlayerName || players.length >= MAX_PLAYERS}
                            >
                                Th√™m
                            </button>
                        </div>
                        {players.length >= MAX_PLAYERS && <p className="text-sm text-danger mt-1">ƒê√£ ƒë·∫°t t·ªëi ƒëa {MAX_PLAYERS} ng∆∞·ªùi ch∆°i.</p>}
                    </div>

                    {/* Danh s√°ch ng∆∞·ªùi ch∆°i ƒë√£ ch·ªçn */}
                    <div className="mb-8 p-4 bg-indigo-50 rounded-lg border border-indigo-200">
                        <h3 className="text-lg font-semibold text-primary mb-2">Ng∆∞·ªùi ch∆°i hi·ªán t·∫°i:</h3>
                        <div className="flex flex-wrap gap-2">
                            {players.map(p => (
                                <span key={p.id} className="bg-primary text-white text-sm px-3 py-1 rounded-full flex items-center">
                                    {p.name}
                                    <button 
                                        onClick={() => handlePlayerToggle(p)}
                                        className="ml-2 text-white/80 hover:text-white font-bold text-xs"
                                    >
                                        &times;
                                    </button>
                                </span>
                            ))}
                        </div>
                        {players.length === 0 && <p className="text-sm text-gray-500 italic">Ch∆∞a c√≥ ng∆∞·ªùi ch∆°i n√†o ƒë∆∞·ª£c ch·ªçn.</p>}
                    </div>

                    {/* N√∫t B·∫Øt ƒë·∫ßu */}
                    <button
                        onClick={handleStartGame}
                        disabled={players.length < 2}
                        className="w-full py-3 bg-secondary text-white font-bold text-xl rounded-xl shadow-lg hover:bg-green-600 transition disabled:bg-gray-400"
                    >
                        {players.length < 2 ? 'C·∫ßn 2 ng∆∞·ªùi ch∆°i ƒë·ªÉ b·∫Øt ƒë·∫ßu' : `B·∫ÆT ƒê·∫¶U TR√í CH∆†I (${maxRounds} V√ÅN)`}
                    </button>
                </div>
            );

            // Stage 1: Playing
            const renderPlaying = () => (
                <div className="p-4 sm:p-6">
                    <h2 className="text-xl sm:text-2xl font-bold text-primary mb-4 text-center">
                        V√ÅN {history.length + 1} / {maxRounds}
                    </h2>
                    
                    {/* B·∫£ng t·ªïng ƒëi·ªÉm hi·ªán t·∫°i (ƒê√£ lo·∫°i b·ªè) */}
                    
                    {/* V√πng Ghi ƒêi·ªÉm */}
                    <div className="mb-4">
                        <button
                            onClick={handleNewScoreClick}
                            className={`w-full py-3 font-bold text-white rounded-xl shadow-lg transition duration-300 transform hover:scale-[1.01] ${isScoringMode ? 'bg-warning hover:bg-amber-600 animate-pulse-slow' : 'bg-primary hover:bg-indigo-700'}`}
                        >
                            {isScoringMode ? 'X√ÅC NH·∫¨N GHI ƒêI·ªÇM V√ÅN N√ÄY' : 'GHI ƒêI·ªÇM V√ÅN M·ªöI'}
                        </button>

                        {isScoringMode && (
                            <div className="mt-4 p-4 bg-indigo-50 rounded-xl shadow border border-indigo-200 animate-fade-in">
                                <h4 className="font-semibold text-primary mb-3">Nh·∫≠p ƒëi·ªÉm v√°n {history.length + 1}:</h4>
                                {playerScores.map(p => (
                                    <div key={p.id} className="flex items-center space-x-2 mb-3">
                                        <span className="w-1/3 text-gray-700 truncate">{p.name}:</span>
                                        <div className="flex w-2/3 space-x-1">
                                            <button 
                                                onClick={() => handleScoreChange(p.id, (roundScoreInputs[p.id] || 0) - 1)}
                                                className="p-2 bg-danger text-white rounded-lg hover:bg-red-600 font-bold"
                                            >
                                                -
                                            </button>
                                            <input
                                                type="number"
                                                value={roundScoreInputs[p.id] === 0 && roundScoreInputs[p.id] !== '' ? '0' : roundScoreInputs[p.id]}
                                                onChange={(e) => handleScoreChange(p.id, e.target.value)}
                                                className="flex-grow p-2 border border-gray-300 rounded-lg text-center font-mono"
                                                placeholder="ƒêi·ªÉm..."
                                            />
                                            <button 
                                                onClick={() => handleScoreChange(p.id, (roundScoreInputs[p.id] || 0) + 1)}
                                                className="p-2 bg-secondary text-white rounded-lg hover:bg-green-600 font-bold"
                                            >
                                                +
                                            </button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                    
                    {/* C√°c n√∫t ch·ª©c nƒÉng */}
                    <div className="flex justify-between space-x-2 mb-4">
                         <button
                            onClick={handleUndo}
                            disabled={history.length === 0 || isScoringMode}
                            className="flex-1 py-2 bg-warning text-white font-semibold rounded-lg hover:bg-amber-600 transition disabled:bg-gray-400"
                        >
                            ‚Ü©Ô∏è Ho√†n T√°c
                        </button>
                        <button
                            onClick={handleSetRoundsClick}
                            disabled={isScoringMode}
                            className="flex-1 py-2 bg-blue-500 text-white font-semibold rounded-lg hover:bg-blue-600 transition disabled:bg-gray-400"
                        >
                            üîÅ Set V√°n
                        </button>
                    </div>
                    <button
                        onClick={() => setGameState('game_over')}
                        disabled={isScoringMode}
                        className="w-full py-2 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-700 transition disabled:bg-gray-400 mb-4"
                    >
                        üõë K·∫øt Th√∫c Ngay
                    </button>
                    
                    {/* L·ªãch s·ª≠ ƒëi·ªÉm (B·∫£ng) */}
                    <div className="bg-white p-4 rounded-xl shadow-lg">
                        <button 
                            onClick={() => setShowHistory(prev => !prev)}
                            className="w-full text-left text-lg font-semibold text-gray-700 mb-2 p-2 hover:bg-gray-100 rounded-lg transition flex justify-between items-center"
                        >
                            5. L·ªãch S·ª≠ ƒêi·ªÉm ({history.length} V√°n) {showHistory ? '‚ñ≤' : '‚ñº'}
                        </button>
                        {showHistory && (
                            <div className="overflow-x-auto mt-2 max-h-64">
                                <table className="min-w-full divide-y divide-gray-200">
                                    <thead className="bg-gray-50 sticky top-0">
                                        <tr>
                                            <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">V√°n</th>
                                            {players.map(p => (
                                                <th key={p.id} className="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase truncate" title={p.name}>{p.name}</th>
                                            ))}
                                        </tr>
                                    </thead>
                                    <tbody className="bg-white divide-y divide-gray-200">
                                        {[...history].reverse().map(entry => (
                                            <tr key={entry.round}>
                                                <td className="px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-900">{entry.round}</td>
                                                {players.map(p => {
                                                    const score = entry.scores[p.id] || 0;
                                                    const colorClass = score > 0 ? 'text-secondary font-bold' : (score < 0 ? 'text-danger' : 'text-gray-500');
                                                    return (
                                                        <td key={p.id} className={`px-3 py-2 whitespace-nowrap text-sm text-center ${colorClass}`}>
                                                            {score > 0 ? `+${score}` : score}
                                                        </td>
                                                    );
                                                })}
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}
                    </div>
                </div>
            );

            // Stage 2: Game Over
            const renderGameOver = () => (
                <div className="p-6 text-center animate-bounce-in">
                    <h2 className="text-4xl font-extrabold text-danger mb-6">üéâ TR√í CH∆†I K·∫æT TH√öC! üéâ</h2>
                    <p className="text-xl font-medium text-gray-700 mb-8">T·ªïng s·ªë v√°n ƒë√£ ch∆°i: <span className="text-primary font-bold">{history.length}</span></p>

                    {/* B·∫£ng X·∫øp H·∫°ng */}
                    <div className="bg-white p-6 rounded-xl shadow-2xl mb-8">
                        <h3 className="text-2xl font-bold text-primary mb-4 border-b pb-2">üèÜ B·∫¢NG X·∫æP H·∫†NG</h3>
                        {playerScores.map((p, index) => (
                            <div 
                                key={p.id} 
                                className={`flex justify-between items-center py-3 px-4 my-2 rounded-lg transition transform duration-300 ${index === 0 ? 'bg-yellow-100 border-2 border-warning scale-105 shadow-lg' : 'bg-gray-50'}`}
                            >
                                <span className={`text-xl font-bold ${index === 0 ? 'text-warning' : 'text-gray-700'}`}>
                                    {index + 1}. {p.name}
                                </span>
                                <span className={`text-3xl font-extrabold ${p.totalScore >= 0 ? 'text-secondary' : 'text-danger'}`}>
                                    {p.totalScore}
                                </span>
                            </div>
                        ))}
                    </div>

                    {/* N√∫t Ch∆°i L·∫°i */}
                    <button
                        onClick={() => {
                            setGameState('setup');
                            setPlayers([]);
                            setHistory([]);
                            setIsScoringMode(false);
                            setRoundScoreInputs({});
                            setMaxRounds(15); // Reset max rounds to default
                            localStorage.clear(); // X√≥a to√†n b·ªô localStorage
                            // Note: We use window.location.reload() to fully reset the component state and localStorage
                            window.location.reload(); 
                        }}
                        className="w-full py-3 bg-secondary text-white font-bold text-xl rounded-xl shadow-lg hover:bg-green-600 transition"
                    >
                        CH∆†I L·∫†I
                    </button>
                </div>
            );
            
            // --- Logic Render Ch√≠nh ---

            return (
                <div className="min-h-screen bg-gray-50 flex justify-center">
                    <div className="w-full max-w-xl mx-auto bg-white shadow-xl rounded-2xl overflow-hidden my-4">
                        <header className="bg-primary text-white p-4 text-center">
                            <h1 className="text-3xl font-extrabold">App Ghi ƒêi·ªÉm</h1>
                        </header>
                        
                        {gameState === 'setup' && renderSetup()}
                        {gameState === 'playing' && renderPlaying()}
                        {gameState === 'game_over' && renderGameOver()}
                    </div>

                    {/* Modal Popup */}
                    <Modal
                        title={modal.type === 'info' ? 'Th√¥ng b√°o' : modal.type === 'confirm_undo' ? 'X√°c nh·∫≠n Ho√†n t√°c' : 'Set l·∫°i S·ªë V√°n Ch∆°i'}
                        isOpen={modal.isOpen}
                        onClose={() => setModal({ isOpen: false, type: null, data: null })}
                        onConfirm={modal.type === 'confirm_undo' ? confirmUndo : confirmResetRounds}
                        confirmText={modal.type === 'info' ? 'ƒê√≥ng' : 'X√°c nh·∫≠n'}
                        showCancel={modal.type !== 'info'}
                        content={renderModalContent()}
                    />
                </div>
            );
        }

        // Render ·ª©ng d·ª•ng React v√†o DOM
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
